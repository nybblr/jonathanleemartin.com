<!DOCTYPE html>
<html ‚ö°>
<head>
    <meta charset="utf-8">

    <title>03. Enforcer Pattern</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <meta name="description" content="üé¨ Find yourself copy-pasting small if-else statements across several functions? üíÇ‚Äç‚ôÇÔ∏è With higher-order functions and the enforcer pattern, you can compose guard behaviors!" />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://jonathanleemartin.com/tldr/03-enforcer-pattern/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="tl;dr" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="03. Enforcer Pattern" />
    <meta property="og:description" content="üé¨ Find yourself copy-pasting small if-else statements across several functions? üíÇ‚Äç‚ôÇÔ∏è With higher-order functions and the enforcer pattern, you can compose guard behaviors!" />
    <meta property="og:url" content="https://jonathanleemartin.com/tldr/03-enforcer-pattern/" />
    <meta property="og:image" content="https://jonathanleemartin.com/content/images/2019/10/03-enforcers.png" />
    <meta property="article:published_time" content="2019-10-09T17:49:05.000Z" />
    <meta property="article:modified_time" content="2019-10-09T17:59:42.000Z" />
    <meta property="article:tag" content="tl;dr" />
    <meta property="article:tag" content="JavaScript" />
    <meta property="article:tag" content="Design Pattern" />
    <meta property="article:tag" content="Web" />
    <meta property="article:tag" content="React" />
    
    <meta property="article:publisher" content="https://www.facebook.com/yellowscale" />
    <meta property="article:author" content="https://www.facebook.com/yellowscale" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="03. Enforcer Pattern" />
    <meta name="twitter:description" content="üé¨ Find yourself copy-pasting small if-else statements across several functions? üíÇ‚Äç‚ôÇÔ∏è With higher-order functions and the enforcer pattern, you can compose guard behaviors!" />
    <meta name="twitter:url" content="https://jonathanleemartin.com/tldr/03-enforcer-pattern/" />
    <meta name="twitter:image" content="https://jonathanleemartin.com/content/images/2019/10/03-enforcers.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Lee Martin" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="tl;dr, JavaScript, Design Pattern, Web, React" />
    <meta name="twitter:site" content="@nybblr" />
    <meta name="twitter:creator" content="@nybblr" />
    <meta property="og:image:width" content="1920" />
    <meta property="og:image:height" content="1080" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "tl;dr",
        "logo": {
            "@type": "ImageObject",
            "url": "https://jonathanleemartin.com/content/images/2019/08/logo.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Jonathan Lee Martin",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://jonathanleemartin.com/author/jonathan/",
        "sameAs": [
            "https://jonathanleemartin.com/",
            "https://www.facebook.com/yellowscale",
            "https://twitter.com/nybblr"
        ]
    },
    "headline": "03. Enforcer Pattern",
    "url": "https://jonathanleemartin.com/tldr/03-enforcer-pattern/",
    "datePublished": "2019-10-09T17:49:05.000Z",
    "dateModified": "2019-10-09T17:59:42.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://jonathanleemartin.com/content/images/2019/10/03-enforcers.png",
        "width": 1920,
        "height": 1080
    },
    "keywords": "tl;dr, JavaScript, Design Pattern, Web, React",
    "description": "üé¨ Find yourself copy-pasting small if-else statements across several functions? üíÇ‚Äç‚ôÇÔ∏è With higher-order functions and the enforcer pattern, you can compose guard behaviors!",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jonathanleemartin.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.27" />
    <link rel="alternate" type="application/rss+xml" title="tl;dr" href="https://jonathanleemartin.com/rss/" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="https://jonathanleemartin.com">tl;dr</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">03. Enforcer Pattern</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/jonathan/">Jonathan Lee Martin</a></p>
                    <time class="post-date" datetime="2019-10-09">2019-10-09</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://jonathanleemartin.com/content/images/2019/10/03-enforcers.png" width="600" height="400" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p>How can you cut down small if-else statements that recur across several functions? Let‚Äôs cover another pattern for nuking if-else statements on today‚Äôs episode of <a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">TL;DR</a>, the JavaScript codecast series that teaches working web developers to craft exceptional software in 5 minutes a week.</p>

<h3 id="transcript">Transcript</h3>
<p>Over the past few episodes, we‚Äôve been covering design patterns to help cut down the size and depth of if-else statements. If you‚Äôre new to this vendetta against if-else statements, hop back to the episode on <a href="https://jonathanleemartin.com/tldr/01-nested-ternaries/">nested ternaries</a> to get up to speed.</p>
<p>Nested ternaries and the <a href="https://jonathanleemartin.com/tldr/02-router-pattern/">Router design pattern</a> have helped us reduce the size and depth of cascading if-else statements, but we haven‚Äôt dealt with terse, non-cascading if-else statements that get copy-pasted across functions. These if-else statements often appear at the beginning of the function as a guard clause. They‚Äôre innocent and short, but like a weed they reproduce with each new feature, and the duplication is tricky to eradicate.</p>
<p>Today we‚Äôre continuing to work on a chatbot that helps outdoor enthusiasts find great trails to hike. This chatbot can respond to simple text commands, like <code>list hikes</code>, <code>add hike</code> and <code>delete hike</code>. If it doesn‚Äôt understand the command, it replies with a fallback message.</p>
<pre><code class="language-javascript">responder('list hikes');
// =&gt; 'Lost Lake, Canyon Creek Meadows'
responder('add hike Mirror Lake');
// =&gt; 'Added Mirror Lake!'
responder('delete hike Mirror Lake');
// =&gt; 'Removed Mirror Lake!'
responder('where is Mirror Lake');
// =&gt; "Sorry, I don't understand."
</code></pre>
<p>The code is a few steps forward from what we had last time: the responder function still follows the Router pattern, but we lifted the individual routes into functions to make the list of responses easier to read.</p>
<pre><code class="language-javascript">let hikes = [
  'Lost Lake',
  'Canyon Creek Meadows',
];

let listHikes = () =&gt;
  hikes.join(', ');

let addHike = ([hike]) =&gt; {
  hikes.push(hike);
  return `Added ${hike}!`;
};

let deleteHike = ([hike]) =&gt; {
  hikes.splice(hikes.indexOf(hike), 1);
  return `Removed ${hike}!`;
};

let fallback = () =&gt;
  `Sorry, I don't understand.`;

let responses = [
  { command: /^list hikes$/,
    response: listHikes },
  { command: /^add hike (.+)$/,
    response: addHike },
  { command: /^delete hike (.+)$/,
    response: deleteHike },
  { command: /^(.*)$/,
    response: fallback },
];

let responder = (message) =&gt; {
  let { command, response } = responses
    .find(({ command, response }) =&gt;
      command.test(message)
    );
  return response(
    command.exec(message).slice(1)
  );
};
</code></pre>
<p>The responder function searches through the list of responses for a command that matches the chat message, then invokes the corresponding response function.</p>
<pre><code class="language-javascript">let responder = (message) =&gt; {
  let { command, response } = responses
    .find(({ command, response }) =&gt;
      command.test(message)
    );
  return response(
    command.exec(message).slice(1)
  );
};
</code></pre>
<p>Today, we want to enforce that the <code>add hike</code> and <code>delete hike</code> commands are executed with the word ‚Äúsudo‚Äù to prevent any accidental changes. Only some commands need sudo, and if the user forgets sudo, we want to provide feedback. So we can‚Äôt just add the word ‚Äúsudo‚Äù directly to the regular expressions.</p>
<pre><code class="language-javascript">responder('list hikes');
// =&gt; 'Lost Lake, Canyon Creek Meadows'
responder('sudo add hike Mirror Lake');
// =&gt; "Sorry, I don't understand."
responder('sudo delete hike Mirror Lake');
// =&gt; "Sorry, I don't understand."
responder('where is Mirror Lake');
// =&gt; "Sorry, I don't understand."
</code></pre>
<p>We can make the regular expressions a little more lenient so the command is at least recognized:</p>
<pre><code class="language-diff"> let responses = [
-  { command: /^list hikes$/,
+  { command: /list hikes$/,
   ...
-  { command: /^add hike (.+)$/,
+  { command: /add hike (.+)$/,
   ...
-  { command: /^delete hike (.+)$/,
+  { command: /delete hike (.+)$/,
   ...
 ];
</code></pre>
<p>But how should we enforce the use of sudo for these admin commands?</p>
<p>One tempting way to support a new, shared behavior like this is to add a new property to each response object: we‚Äôll call it <code>adminOnly</code>.</p>
<pre><code class="language-diff"> let responses = [
   ...
   { command: /add hike (.+)$/,
+    adminOnly: true,
     response: addHike },
   { command: /delete hike (.+)$/,
+    adminOnly: true,
     response: deleteHike },
   ...
 ];
</code></pre>
<p>Then in the responder, we‚Äôll add a guard clause that checks if the route requires ‚Äúsudo‚Äù, and if the word is missing, we‚Äôll respond with ‚ÄúNot allowed.‚Äù</p>
<pre><code class="language-diff"> let responder = (message) =&gt; {
-  let { command, response } = responses
+  let { command, adminOnly, response } = responses
     .find(({ command, response }) =&gt;
       command.test(message)
     );
+  if (adminOnly &amp;&amp; !message.startsWith('sudo')) {
+    return 'Not allowed!';
+  }
   return response(
     command.exec(message).slice(1)
   );
 };
</code></pre>
<p>When faced with this kind of feature request ‚Äî that is, supporting a new behavior that can be generalized for related functions ‚Äî many developers would probably do what we did and insert that behavior logic into the responder function. It‚Äôs quick, keeps the code <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a>, and it just feels nice. But it‚Äôs also a premature abstraction that conflates responsibilities: the responder function has become responsible for routing and authorization logic.</p>
<p>Every time a feature requires a new qualifier, the responder will be edited. It won‚Äôt be long before there are several short if-else statements in the responder ‚Äî which is precisely what the Router pattern was intended to help us demolish.</p>
<p>From a testing perspective, we can‚Äôt unit test the authorization logic for individual chat commands without going through the responder. We can only write integration tests for authorization.</p>
<p>Whenever you‚Äôre tempted to alter terse, single responsibility functions to incorporate a new behavior, take a step back and identify the most naive solution that still satisfies the <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility principle</a>.</p>
<p>For example, what if we added this admin enforcement logic directly to the <code>addHike()</code> and <code>deleteHike()</code> response functions instead of the responder?</p>
<p>Let‚Äôs undo our changes. For the response functions to determine if sudo was used, we need to pass the full chat message:</p>
<pre><code class="language-diff"> let responder = (message) =&gt; {
   ...
   return response(
-    command.exec(message).slice(1)
+    { message,
+      match: command.exec(message).slice(1) }
   );
 };
</code></pre>
<p>In <code>addHike()</code>, we can add a guard clause that checks if the message starts with ‚Äúsudo‚Äù and returns ‚ÄúNot allowed‚Äù if it doesn‚Äôt. We can copy-paste this guard clause to <code>deleteHike()</code>.</p>
<pre><code class="language-javascript">let addHike = ({ match: [hike], message }) =&gt; {
  if (!message.startsWith('sudo')) {
    return 'Not allowed!';
  }
  hikes.push(hike);
  return `Added ${hike}!`;
};

let deleteHike = ({ match: [hike], message }) =&gt; {
  if (!message.startsWith('sudo')) {
    return 'Not allowed!';
  }
  hikes.splice(hikes.indexOf(hike), 1);
  return `Removed ${hike}!`;
};
</code></pre>
<p>This naive solution is feature complete and leaves the responder function focused on one responsibility. But now one if-else statement has multiplied into two in our response functions. So how are we any better off? Well, by letting the naive solution play out, we‚Äôre equipped to build an abstraction that solves a concrete problem: the duplicated guard clause.</p>
<p>This guard clause represents a behavior, which we could call <code>adminOnly</code>. When you hear the word ‚Äúbehavior‚Äù or ‚Äútrait‚Äù, we‚Äôre referring to a cross-cutting concern that can be shared across several functions, even if they do completely different things. The <code>addHike()</code> and <code>deleteHike()</code> response functions have different jobs, but they share a similar behavior.</p>
<p>A great way to share behavior in a language that supports functional programming is through function composition.</p>
<p>Suppose we had a function, called <code>adminOnly()</code>, that receives an unprotected function like <code>addHike()</code>, and returns a new version of <code>addHike()</code> that enforces the use of the ‚Äúsudo‚Äù keyword:</p>
<pre><code class="language-diff"> let responses = [
   ...
   { command: /add hike (.+)$/,
-    response: addHike },
+    response: adminOnly(addHike) },
   { command: /delete hike (.+)$/,
-    response: deleteHike },
+    response: adminOnly(deleteHike) },
   ...
 ];
</code></pre>
<p><code>adminOnly()</code> is easy to code up once you get the parameter signature right. If the message contains the word ‚Äúsudo‚Äù, it invokes the route it received as an argument. Otherwise, it returns the failure message.</p>
<pre><code class="language-javascript">let adminOnly = (route) =&gt; (request) =&gt;
  request.message.split(' ').includes('sudo')
    ? route(request)
    : 'Not allowed!'
;
</code></pre>
<p>I like to call this kind of behavior function an <strong>Enforcer</strong>: it‚Äôs a <a href="https://medium.com/javascript-scene/higher-order-functions-composing-software-5365cf2cbe99">Higher-Order Function</a> with a guard clause that enforces some authorization rule, like requiring the word ‚Äúsudo‚Äù or checking if the current user is an admin.</p>
<p>The <code>add hike</code> and <code>delete hike</code> commands behave exactly as they did in our first solution. But this time, we didn‚Äôt have to edit existing functions to support the new behavior: we only added new functions and composed them. It‚Äôs as though we‚Äôre writing immutable code, and like immutable data structures, this style of coding has great design benefits and prevents regressions. None of our existing unit tests will change, and the new code already follows the single responsibility principle.</p>
<p>We can even add new enforcement behaviors.</p>
<p>Suppose we want to enforce that the <code>list hikes</code> command include the word ‚Äúplease‚Äù with a new behavior called <code>askNicely()</code>. All we need to do is duplicate the <code>adminOnly()</code> behavior, then change the keyword and failure message:</p>
<pre><code class="language-javascript">let askNicely = (route) =&gt; (request) =&gt;
  request.message.split(' ').includes('please')
    ? route(request)
    : 'You should ask nicely.'
;

let responses = [
  { command: /list hikes$/,
    response: askNicely(listHikes) },
  ...
];
</code></pre>
<p>And because these enforcers are built through function composition, they layer without additional work. To make the <code>delete hike</code> command require ‚Äúsudo‚Äù and ‚Äúplease‚Äù, we just compose the behaviors.</p>
<pre><code class="language-diff"> let responses = [
   ...
   { command: /delete hike (.+)$/,
-    response: adminOnly(deleteHike) },
+    response: adminOnly(askNicely(deleteHike)) },
   ...
 ];
</code></pre>
<p>But what about the duplication between these behaviors? Other than a different keyword and failure message, they look exactly the same. We can DRY them up into an enforcer factory called <code>requireKeyword()</code> that returns a new behavior based on a customizable keyword and failure message.</p>
<pre><code class="language-javascript">let requireKeyword = (word, fail) =&gt; (route) =&gt; (request) =&gt;
  request.message.split(' ').includes(word)
    ? route(request)
    : fail
;
</code></pre>
<p>Now the <code>adminOnly()</code> and <code>askNicely()</code> behaviors can be replaced with partial invocations of the <code>requireKeyword()</code> enforcer factory!</p>
<pre><code class="language-javascript">let adminOnly = requireKeyword('sudo', 'Not allowed!');
let askNicely = requireKeyword('please', 'You should ask nicely.');
</code></pre>
<p>We‚Äôve landed on a solution that satisfies the single responsibility principle, didn‚Äôt change existing functions, and produces descriptive code.</p>
<pre><code class="language-javascript">responder('list hikes');
// =&gt; 'You should ask nicely.'
responder('please list hikes');
// =&gt; 'Lost Lake, Canyon Creek Meadows'
responder('add hike Mirror Lake');
// =&gt; 'Not allowed!'
responder('sudo add hike Mirror Lake');
// =&gt; 'Added Mirror Lake!'
responder('sudo please delete hike Mirror Lake');
// =&gt; 'Removed Mirror Lake!'
</code></pre>
<p>The enforcer pattern pops up in other places, like guarding authenticated pages in a React web app:</p>
<pre><code class="language-javascript">let requireLogin = (Component) =&gt; (props) =&gt;
  props.currentUser
    ? &lt;Component {...props} /&gt;
    : &lt;Redirect to="/login" /&gt;

let ActivityPage = ({ notifications }) =&gt;
  &lt;section&gt;
    &lt;h2&gt;Recent Activity&lt;/h2&gt;
    &lt;Notifications notifications={notifications} /&gt;
  &lt;/section&gt;

export default requireLogin(ActivityPage);

</code></pre>
<p>Or rendering a loading indicator while an API request finishes:</p>
<pre><code class="language-javascript">let withLoader = (msg) =&gt; (Component) =&gt; (props) =&gt;
  props.loading
    ? &lt;LoadingIndicator message={message} /&gt;
    : &lt;Component {...props} /&gt;

let ProfileScreen = ({ stories, user }) =&gt;
  &lt;div&gt;
    &lt;h2&gt;Stories from {user.name}&lt;/h2&gt;
    &lt;StoryList stories={stories} /&gt;
  &lt;/div&gt;

export default withLoader('Wait‚Ä¶')(ProfileScreen);

</code></pre>
<p>Or protecting backend routes based on the current user:</p>
<pre><code class="language-javascript">let listAllUsers = (req, res) =&gt; {
  res.send(users);
};

let adminOnly = (req, res, next) =&gt;
  req.user &amp;&amp; req.user.isAdmin
    ? next()
    : res.sendStatus(401);

app.get(
  adminOnly,
  listAllUsers,
);

</code></pre>
<p>But we wouldn‚Äôt have discovered this pattern without writing the naive copy-paste solution first and letting the repetition guide the refactor.</p>
<p>So don‚Äôt try to prevent copy-paste prematurely: instead, let the code be duplicated, then DRY up the duplication through function composition. The naive copy-paste solution will lead you to a resilient abstraction that won‚Äôt be outgrown by the next feature.</p>
<p>Today, look for short, repeated if-else statements near the beginning of the function that guard the rest of the function, and try extracting them into an enforcer function.</p>
<p>That‚Äôs it for today. Want to keep leveling up your craft? Don‚Äôt forget to <a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">subscribe to the channel</a> for more rapid codecasts on design patterns, refactoring and development approaches.</p>


            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://jonathanleemartin.com">tl;dr</a> &copy; 2019</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
