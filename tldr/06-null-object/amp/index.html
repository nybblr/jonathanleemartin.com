<!DOCTYPE html>
<html ‚ö°>
<head>
    <meta charset="utf-8">

    <title>Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <meta name="description" content="üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!" />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://jonathanleemartin.com/tldr/06-null-object/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="tl;dr" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts" />
    <meta property="og:description" content="üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!" />
    <meta property="og:url" content="https://jonathanleemartin.com/tldr/06-null-object/" />
    <meta property="og:image" content="https://jonathanleemartin.com/content/images/2019/10/06-null-object.png" />
    <meta property="article:published_time" content="2019-10-30T16:08:24.000Z" />
    <meta property="article:modified_time" content="2019-10-30T16:14:22.000Z" />
    <meta property="article:tag" content="tl;dr" />
    <meta property="article:tag" content="JavaScript" />
    <meta property="article:tag" content="Design Pattern" />
    <meta property="article:tag" content="Node" />
    
    <meta property="article:publisher" content="https://www.facebook.com/yellowscale" />
    <meta property="article:author" content="https://www.facebook.com/yellowscale" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts" />
    <meta name="twitter:description" content="üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!" />
    <meta name="twitter:url" content="https://jonathanleemartin.com/tldr/06-null-object/" />
    <meta name="twitter:image" content="https://jonathanleemartin.com/content/images/2019/10/06-null-object.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Lee Martin" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="tl;dr, JavaScript, Design Pattern, Node" />
    <meta name="twitter:site" content="@nybblr" />
    <meta name="twitter:creator" content="@nybblr" />
    <meta property="og:image:width" content="1920" />
    <meta property="og:image:height" content="1080" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "tl;dr",
        "logo": {
            "@type": "ImageObject",
            "url": "https://jonathanleemartin.com/content/images/2019/08/logo.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Jonathan Lee Martin",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://jonathanleemartin.com/author/jonathan/",
        "sameAs": [
            "https://jonathanleemartin.com/",
            "https://www.facebook.com/yellowscale",
            "https://twitter.com/nybblr"
        ]
    },
    "headline": "Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts",
    "url": "https://jonathanleemartin.com/tldr/06-null-object/",
    "datePublished": "2019-10-30T16:08:24.000Z",
    "dateModified": "2019-10-30T16:14:22.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://jonathanleemartin.com/content/images/2019/10/06-null-object.png",
        "width": 1920,
        "height": 1080
    },
    "keywords": "tl;dr, JavaScript, Design Pattern, Node",
    "description": "üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jonathanleemartin.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.27" />
    <link rel="alternate" type="application/rss+xml" title="tl;dr" href="https://jonathanleemartin.com/rss/" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="https://jonathanleemartin.com">tl;dr</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">06. Null Object Pattern</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/jonathan/">Jonathan Lee Martin</a></p>
                    <time class="post-date" datetime="2019-10-30">2019-10-30</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://jonathanleemartin.com/content/images/2019/10/06-null-object.png" width="600" height="400" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p>Are your functions overly distrustful? We‚Äôll see just how the Null Object Pattern can restore a culture of trust and cut down flow control bugs on today‚Äôs episode of <a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">TL;DR</a>, the JavaScript codecast series that teaches working web developers to craft exceptional software in 5 minutes a week.</p>

<h3 id="transcript">Transcript</h3>
<p><a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">We just hit 100 subscribers</a>, and I want to thank you so much for watching, sharing and subscribing! This series is based on problems faced in real-world consulting projects, so each episode is designed to teach powerful patterns that save you and your team time. But that takes a lot of time! Each 5‚Äì7 minute episode takes around 30 hours from inception to release.</p>
<p>So I want to ask you to consider <a href="https://www.patreon.com/jonathanleemartin">supporting me on Patreon</a> so I can keep crafting great content that helps you craft exceptional code. Think of it as a pay-what-you-like screencast subscription.</p>
<p>Alright, on to today‚Äôs pattern.</p>
<p>When each line of code has to defend against previous lines, we‚Äôre left with a tangle of branching and flow control constructs, like if‚Ä¶else and early returns. This is especially tricky for error handling code, which can turn an otherwise docile function into a flow control nightmare.</p>
<p>Today we‚Äôre working on authentication middleware that‚Äôs taken from a chapter in my book, <a href="https://jonathanleemartin.com/books/">Functional Design Patterns for Express.js</a>. If you‚Äôre hopping into a Node backend and have loved the design-oriented approach we take on TL;DR, I encourage you to check it out.</p>
<p>We‚Äôre making authenticated HTTP requests to an Express backend and supplying a special token called a <a href="https://jwt.io/">JSON Web Token</a>. If you‚Äôre new to JWTs, think of them as the picture page of a passport: they encode details about the user, and are securely signed so the backend knows they‚Äôre authentic.</p>
<pre><code class="language-javascript">makeRequestWithToken('g00d_t0k3n');
// =&gt; '‚úÖ 200: Welcome to the backend.'
makeRequestWithToken('3mpt1_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
makeRequestWithToken('0ld_t0k3n');
// =&gt; üí• TokenExpiredError: jwt expired
makeRequestWithToken('f@k3_t0k3n');
// =&gt; üí• JsonWebTokenError: jwt malformed
</code></pre>
<p>As long as the token is valid, the backend lets us use any of its APIs. But if the token is missing some information, has expired, or has been tampered with, the backend halts the request in its tracks.</p>
<p>The function responsible for this guard behavior is a middleware function called <code>checkToken()</code>:</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let payload = jwt.verify(req.token, 's3cr3t');

  if (payload &amp;&amp; payload.user) {
    req.user = payload.user;
  } else {
    res.status(401).send('Bad token.');
    return;
  }

  next();
};
</code></pre>
<p>It tries to decode the contents of the JSON Web Token, called the payload. If the token is successfully decoded, it stores the user information on the request object and invokes <code>next()</code> to continue. But if the token is bad, it halts the request and immediately responds with a 401 Unauthorized status code.</p>
<p>But a lot of other things can go wrong. A client could supply an expired token, or they might tamper with it; in either case, the <code>jwt.verify()</code> function throws an exception. Right now, the <code>checkToken()</code> function is completely oblivious to these potential errors.</p>
<p>We should never allow a known exception to go uncaught, otherwise the backend‚Äôs response will just hang. So instead, we need to catch any JWT-related errors and respond with a 401 status code.</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
-  let payload = jwt.verify(req.token, 's3cr3t');
+  let payload;
+  try {
+    payload = jwt.verify(req.token, 's3cr3t');
+  } catch (error) {
+    /* Suppress the error */
+  }

   if (payload &amp;&amp; payload.user) {
     ...
 };

</code></pre>
<p>To do that, we can wrap try‚Ä¶catch around the <code>verify()</code> call. But as we learned in the last two episodes, an <a href="https://jonathanleemartin.com/tldr/04-custom-exceptions/">unqualified catch is almost always a bug</a>. We must only catch error types we intend to handle. We‚Äôll use an if‚Ä¶else statement to rethrow the error if it isn‚Äôt a <code>TokenExpiredError</code> or <code>JsonWebTokenError</code>.</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let payload;
  try {
    payload = jwt.verify(req.token, 's3cr3t');
  } catch (error) {
    if (error instanceof TokenExpiredError
     || error instanceof JsonWebTokenError) {
      /* Suppress the error */
    } else {
      throw error;
    }
  }

  if (payload &amp;&amp; payload.user) {
    req.user = payload.user;
  } else {
    res.status(401).send('Bad token.');
    return;
  }

  next();
};
</code></pre>
<pre><code class="language-javascript">makeRequestWithToken('g00d_t0k3n');
// =&gt; '‚úÖ 200: Welcome to the backend.'
makeRequestWithToken('3mpt1_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
makeRequestWithToken('0ld_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
makeRequestWithToken('f@k3_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
</code></pre>
<p>This is the correct way to handle all these edge cases, but now <code>checkToken()</code> is swimming in flow control constructs: early returns, try‚Ä¶catch, throw, and an unhealthy dose of if‚Ä¶else statements too. And sadly, this style is typical of most popular middleware libraries.</p>
<p>Each line of code is constantly on guard, as though it can‚Äôt trust the lines before it. So how do we nuke these flow control constructs?</p>
<p><a href="https://jonathanleemartin.com/tldr/05-exception-composition">Last episode</a> we derived a helper called <code>swallow()</code> that could help. <code>swallow()</code> is a <a href="https://medium.com/javascript-scene/higher-order-functions-composing-software-5365cf2cbe99">higher-order function</a> that runs some code that could potentially blow up. If it does, it suppresses the error and instead returns the result of another function.</p>
<pre><code class="language-javascript">let swallow = (type) =&gt; (fail) =&gt; (fn) =&gt; (...args) =&gt; {
  try {
    return fn(...args);
  } catch (error) {
    if (!(error instanceof type)) { throw error; }
    return fail(error);
  }
};

let safeFindBlog = swallow(NotFound)(
  () =&gt; 'Missing blog'
)(unsafeFindBlog);

unsafeFindBlog({ id: 5 });
// =&gt; { title: 'I üòç JS' }
unsafeFindBlog({ id: 100 });
// =&gt; üí• NotFound
safeFindBlog({ id: 100 });
// =&gt; 'Missing blog'
</code></pre>
<p>Let‚Äôs try using <code>swallow()</code> in place of the try‚Ä¶catch and if‚Ä¶else statements. If <code>jwt.verify()</code> throws a <code>TokenExpiredError</code>, we‚Äôll catch it and instead return null to make it mirror the old behavior.</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let payload =
    swallow(TokenExpiredError)(
      () =&gt; null
    )(
      () =&gt; jwt.verify(req.token, 's3cr3t')
    )();

  if (payload &amp;&amp; payload.user) {
    ...
};
</code></pre>
<p>Since <code>swallow()</code> is a higher-order function, we can also catch a <code>JsonWebTokenError</code> by composing it with another <code>swallow()</code>.</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
   let payload =
+    swallow(JsonWebTokenError)(
+      () =&gt; null
+    )(
       swallow(TokenExpiredError)(
         () =&gt; null
       )(
         () =&gt; jwt.verify(req.token, 's3cr3t')
+      )
     )();

   if (payload &amp;&amp; payload.user) {
     ...
 };
</code></pre>
<p>This is horrible to read, but it behaves correctly and removed several flow control constructs. What about the remaining conditionals? It would help if we could go ahead and destructure the payload‚Äôs user property. Then the following code could be less defensive about the shape of payload.</p>
<p>Well if a <code>TokenExpiredError</code> is thrown, <code>swallow()</code> will return null, which isn‚Äôt an object and can‚Äôt be destructured. So what if instead of returning null, we returned a benign value that has the shape of a valid payload, such as an object with a user property? Then even if an exception is thrown, we can be sure that the payload will have the right shape.</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
-  let payload =
+  let { user } =
     swallow(JsonWebTokenError)(
-      () =&gt; null
+      () =&gt; ({ user: null })
     )(
       swallow(TokenExpiredError)(
-        () =&gt; null
+        () =&gt; ({ user: null })
       )(
         () =&gt; jwt.verify(req.token, 's3cr3t')
       )
     )();

-  if (payload &amp;&amp; payload.user) {
+  if (user) {
-    req.user = payload.user;
+    req.user = user;
   } else {
     ...
 };
</code></pre>
<p>By substituting a benign value as early as possible, we don‚Äôt have to be defensive later on. In Object-Oriented Programming, this benign value is called a <a href="https://en.wikipedia.org/wiki/Null_object_pattern">Null Object</a>. It‚Äôs often a subclass of the expected object type, and should respond to the same messages.</p>
<pre><code class="language-javascript">class User {
  constructor({ id, name, email }) {
    this.name = name;
    this.email = email;
    this.id = id || generateId();
  }
}

class NullUser extends User {
  constructor() {
    super({
      id: '00000000',
      name: 'NullUser',
      email: 'null@app.com'
    });
  }
}
</code></pre>
<p>Since we‚Äôre taking a more functional approach, we won‚Äôt create a Null Object class, but we can still lift this Null Object into a variable called <code>nullPayload</code> to better communicate intent.</p>
<pre><code class="language-javascript">let nullPayload = { user: null };
</code></pre>
<p>I use this pattern so often, I like to create a utility called <code>rescueWith()</code> that behaves exactly like <code>swallow()</code>, except that we don‚Äôt need the extra function wrapping around the <code>nullPayload</code>.</p>
<pre><code class="language-javascript">let rescueWith = (type) =&gt; (fallback) =&gt;
  swallow(type)(() =&gt; fallback);

let checkToken = (req, res, next) =&gt; {
  let { user } =
    rescueWith(JsonWebTokenError)(nullPayload)(
      rescueWith(TokenExpiredError)(nullPayload)(
        () =&gt; jwt.verify(req.token, 's3cr3t')
      )
    )();

  if (user) {
    ...
};
</code></pre>
<p>That helps cut down the syntactic noise, and once we move the arguments for <code>jwt.verify()</code> to the end:</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let { user } =
    rescueWith(JsonWebTokenError)(nullPayload)(
      rescueWith(TokenExpiredError)(nullPayload)(
        jwt.verify
      )
    )(req.token, 's3cr3t');

  if (user) {
    ...
</code></pre>
<p>We now see the entire function can be extracted from <code>checkToken()</code> altogether! Let‚Äôs call it <code>safeVerifyJWT</code> since it works exactly like <code>jwt.verify()</code> but just replaces errors with a safe value.</p>
<pre><code class="language-javascript">let safeVerifyJWT =
  rescueWith(JsonWebTokenError)(nullPayload)(
    rescueWith(TokenExpiredError)(nullPayload)(
      jwt.verify
    )
  );

let checkToken = (req, res, next) =&gt; {
  let { user } = safeVerifyJWT(req.token, 's3cr3t');

  if (user) {
    ...
</code></pre>
<p>Finally, let‚Äôs whip out our <code>compose()</code> helper to remove the nesting.</p>
<pre><code class="language-javascript">let safeVerifyJWT = compose(
  rescueWith(JsonWebTokenError)(nullPayload),
  rescueWith(TokenExpiredError)(nullPayload),
)(jwt.verify);
</code></pre>
<p>This refactor has helped us discover the boundary we should have seen all along: all that try‚Ä¶catch and if‚Ä¶else nonsense was just about making a version of <code>jwt.verify()</code> that behaved a little differently ‚Äî just the sort of thing higher-order functions do so well.</p>
<p>And now <code>checkToken()</code> is back to focusing on the naive happy path. With all the noise out of the way, we can confidently reason that <code>next()</code> will only be called if there‚Äôs a user, so we can move it into the if clause and eliminate the early return in the else. This code now has zero flow control constructs!</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
   let { user } = safeVerifyJWT(req.token, 's3cr3t');

   if (user) {
     req.user = user;
+    next();
   } else {
     res.status(401).send('Bad token.');
-    return;
   }

-  next();
 };
</code></pre>
<p>Optionally, we can even rewrite the remaining if‚Ä¶else statement into <a href="https://jonathanleemartin.com/tldr/01-nested-ternaries/">a ternary expression</a> to prohibit any flow control constructs at all. But whether or not you use the ternary, the final <code>checkToken()</code> function reads nicely thanks to small, well-behaved functions and a predictable flow.</p>
<pre><code class="language-javascript">let nullPayload = { user: null };

let safeVerifyJWT = compose(
  rescueWith(JsonWebTokenError)(nullPayload),
  rescueWith(TokenExpiredError)(nullPayload),
)(jwt.verify);

let checkToken = (req, res, next) =&gt; {
  let { user } = safeVerifyJWT(req.token, 's3cr3t');

  return user
    ? (req.user = user, next())
    : res.status(401).send('Bad token.');
};
</code></pre>
<p>We‚Äôve been building up to this refactor for a few episodes, but by letting things get ugly instead of skipping directly to <code>rescueWith()</code>, we saw how composition always wins in the end ‚Äî even if the process seems to produce more code.</p>
<p>And that journey helped us identify and solve the underlying problem: trust. Each line of code was defensive because it couldn‚Äôt safely trust the results of lines before it. With this variation of the Null Object Pattern, we replaced edge cases with benign values. Once we did that, the boundaries became detangled so we could extract a safe version of <code>jwt.verify()</code>.</p>
<p>Trust is a powerful refactoring tool. Today, look for try‚Ä¶catch statements, followed by if‚Ä¶else statements, and use the Null Object Pattern and <code>rescueWith()</code> to restore a culture of trust.</p>
<p>That‚Äôs it for today! If you loved today‚Äôs episode, please consider <a href="https://www.patreon.com/jonathanleemartin">supporting the channel on Patreon</a>. Want to keep leveling up your craft? Don‚Äôt forget to <a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">subscribe to the channel</a> for more rapid codecasts on design patterns, refactoring and development approaches.</p>


            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://jonathanleemartin.com">tl;dr</a> &copy; 2019</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
