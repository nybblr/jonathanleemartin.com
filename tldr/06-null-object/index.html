<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/app.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/assets/css/highlight.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=DM+Sans:400,400i,700,700i&display=swap" media="screen" />
    <link rel="stylesheet" type="text/css" href="/assets/css/fonts.css" media="screen" />

      <style>
    .m-hero__picture {
      background-image: url(/content/images/size/w2000/2019/10/06-null-object.png);
    }
  
    @media(max-width: 1000px) {
      .m-hero__picture {
        background-image: url(/content/images/size/w1000/2019/10/06-null-object.png);
      }
    }
  
    @media(max-width: 600px) {
      .m-hero__picture {
        background-image: url(/content/images/size/w600/2019/10/06-null-object.png);
      }
    }
  </style>


    <meta name="description" content="üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!" />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://jonathanleemartin.com/tldr/06-null-object/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="tl;dr" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts" />
    <meta property="og:description" content="üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!" />
    <meta property="og:url" content="https://jonathanleemartin.com/tldr/06-null-object/" />
    <meta property="og:image" content="https://jonathanleemartin.com/content/images/2019/10/06-null-object.png" />
    <meta property="article:published_time" content="2019-10-30T16:08:24.000Z" />
    <meta property="article:modified_time" content="2019-10-30T16:14:22.000Z" />
    <meta property="article:tag" content="tl;dr" />
    <meta property="article:tag" content="JavaScript" />
    <meta property="article:tag" content="Design Pattern" />
    <meta property="article:tag" content="Node" />
    
    <meta property="article:publisher" content="https://www.facebook.com/yellowscale" />
    <meta property="article:author" content="https://www.facebook.com/yellowscale" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts" />
    <meta name="twitter:description" content="üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!" />
    <meta name="twitter:url" content="https://jonathanleemartin.com/tldr/06-null-object/" />
    <meta name="twitter:image" content="https://jonathanleemartin.com/content/images/2019/10/06-null-object.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Lee Martin" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="tl;dr, JavaScript, Design Pattern, Node" />
    <meta name="twitter:site" content="@nybblr" />
    <meta name="twitter:creator" content="@nybblr" />
    <meta property="og:image:width" content="1920" />
    <meta property="og:image:height" content="1080" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "tl;dr",
        "logo": {
            "@type": "ImageObject",
            "url": "https://jonathanleemartin.com/content/images/2019/08/logo.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Jonathan Lee Martin",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://jonathanleemartin.com/author/jonathan/",
        "sameAs": [
            "https://jonathanleemartin.com/",
            "https://www.facebook.com/yellowscale",
            "https://twitter.com/nybblr"
        ]
    },
    "headline": "Null Object Pattern: Write Trustworthy Code &lt;/&gt; TL;DR: JavaScript Codecasts",
    "url": "https://jonathanleemartin.com/tldr/06-null-object/",
    "datePublished": "2019-10-30T16:08:24.000Z",
    "dateModified": "2019-10-30T16:14:22.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://jonathanleemartin.com/content/images/2019/10/06-null-object.png",
        "width": 1920,
        "height": 1080
    },
    "keywords": "tl;dr, JavaScript, Design Pattern, Node",
    "description": "üé¨ Is your code overly defensive? ü§® A functional take on the Null Object Pattern can restore a culture of trust and eliminate flow control bugs!",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jonathanleemartin.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.27" />
    <link rel="alternate" type="application/rss+xml" title="tl;dr" href="https://jonathanleemartin.com/rss/" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-30173272-6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30173272-6');
</script>

    <script>
      const ghostHost = "https://jonathanleemartin.com"
    </script>
  </head>
  <body class="post-template tag-tldr tag-javascript tag-design-pattern tag-node">
    

<div class="main-wrap">
  
  <header class="m-header with-picture js-header">
  <div class="m-mobile-topbar">
    <button class="m-icon-button in-mobile-topbar js-open-menu" aria-label="Open menu">
      <span class="icon-menu"></span>
    </button>
      <a href="https://jonathanleemartin.com" class="m-logo in-mobile-topbar">
        <img src="/content/images/2019/08/logo.png" alt="tl;dr">
      </a>
    <button class="m-icon-button in-mobile-topbar js-open-search" aria-label="Open search">
      <span class="icon-search"></span>
    </button>
  </div>

  <div class="m-menu js-menu">
    <button class="m-icon-button outlined as-close-menu js-close-menu" aria-label="Close menu">
      <span class="icon-close"></span>
    </button>
    <div class="m-menu__main">
      <div class="l-wrapper">
        <div class="m-nav">
          <nav class="m-nav__left">
              
<ul role="menu">
  <li class="only-desktop" role="menuitem">
    <a href="https://jonathanleemartin.com" class="m-logo">
      <img src="/content/images/2019/08/logo.png" alt="tl;dr">
    </a>
  </li>
    <li class="nav-blog">
      <a href="https://jonathanleemartin.com/blog/">Blog</a>
    </li>
    <li class="nav-episodes">
      <a href="https://jonathanleemartin.com/tldr/">Episodes</a>
    </li>
    <li class="nav-youtube">
      <a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">YouTube</a>
    </li>
    <li class="nav-books">
      <a href="https://jonathanleemartin.com/books/">Books</a>
    </li>
  <li role="menuitem" class="js-submenu-option">
    <button class="m-icon-button in-menu-main more js-toggle-submenu" aria-label="Toggle submenu">
      <span class="icon-more"></span>
    </button>
    <div class="m-submenu js-submenu">
      <div class="l-wrapper in-submenu">
        <section class="m-recent-articles">
          <h3 class="m-submenu-title in-recent-articles">Recent articles</h3>
          <div class="js-recent-articles">
                <div>
                  <a href="/tldr/06-null-object/" class="m-recent-article">
                    <div class="m-recent-article__picture">
                      <div style="background-image: url(/content/images/size/w600/2019/10/06-null-object.png);"></div>
                    </div>
                    <h3 class="m-recent-article__title">06. Null Object Pattern</h3>
                    <span class="m-recent-article__date">October 30, 2019</span>
                  </a>
                </div>
                <div>
                  <a href="/tldr/05-exception-composition/" class="m-recent-article">
                    <div class="m-recent-article__picture">
                      <div style="background-image: url(/content/images/size/w600/2019/10/05-exception-composition.png);"></div>
                    </div>
                    <h3 class="m-recent-article__title">05. Exception Composition</h3>
                    <span class="m-recent-article__date">October 23, 2019</span>
                  </a>
                </div>
                <div>
                  <a href="/tldr/04-custom-exceptions/" class="m-recent-article">
                    <div class="m-recent-article__picture">
                      <div style="background-image: url(/content/images/size/w600/2019/10/04-custom-exceptions.png);"></div>
                    </div>
                    <h3 class="m-recent-article__title">04. Custom Exceptions</h3>
                    <span class="m-recent-article__date">October 16, 2019</span>
                  </a>
                </div>
                <div>
                  <a href="/tldr/03-enforcer-pattern/" class="m-recent-article">
                    <div class="m-recent-article__picture">
                      <div style="background-image: url(/content/images/size/w600/2019/10/03-enforcers.png);"></div>
                    </div>
                    <h3 class="m-recent-article__title">03. Enforcer Pattern</h3>
                    <span class="m-recent-article__date">October 9, 2019</span>
                  </a>
                </div>
          </div>
        </section>
        <section class="m-tags">
          <h3 class="m-submenu-title">Tags</h3>
            <ul>
                <li>
                  <a href="/tag/design-pattern/">Design Pattern</a>
                </li>
                <li>
                  <a href="/tag/javascript/">JavaScript</a>
                </li>
                <li>
                  <a href="/tag/node/">Node</a>
                </li>
                <li>
                  <a href="/tag/react/">React</a>
                </li>
                <li>
                  <a href="/tag/web/">Web</a>
                </li>
                <li>
                  <a href="/tag/tldr/">tl;dr</a>
                </li>
            </ul>
        </section>
      </div>
    </div>
  </li>
</ul>

          </nav>
          <button class="m-icon-button in-menu-main js-open-search" aria-label="Open search">
            <span class="icon-search"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</header>
  

  <header class="m-hero with-picture">
      <div class="m-hero__picture in-post"></div>
  </header>
  
  <main>
    <article>
      <div class="l-content">
        <div class="l-wrapper in-post js-aos-wrapper">
          <div class="l-post-content has-subscribe-form js-progress-content">
            <header class="m-heading">
              <h1 class="m-heading__title in-post">06. Null Object Pattern</h1>
              <div class="m-heading__meta">
                <a href="/tag/tldr/" class="m-heading__meta__tag">tl;dr</a>
                <span class="m-heading__meta__divider">&bull;</span>
                <span class="m-heading__meta__time">October 30, 2019</span>
              </div>
            </header>
            <div class="pos-relative js-post-content">
              <div class="m-share">
                <div class="m-share__content js-sticky">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonathanleemartin.com/tldr/06-null-object/" class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Facebook">
                    <span class="icon-facebook"></span>
                  </a>
                  <a href="https://twitter.com/intent/tweet?text=06.%20Null%20Object%20Pattern&url=https://jonathanleemartin.com/tldr/06-null-object/" class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Twitter">
                    <span class="icon-twitter"></span>
                  </a>
                  <button class="m-icon-button filled in-share progress js-scrolltop" aria-label="Scroll to top">
                    <span class="icon-arrow-top"></span>
                    <svg>
                      <circle class="progress-ring__circle js-progress" stroke="#04aeee" fill="transparent" r="0" />
                    </svg>
                  </button>
                </div>
              </div>
              <!--kg-card-begin: markdown--><p>Are your functions overly distrustful? We‚Äôll see just how the Null Object Pattern can restore a culture of trust and cut down flow control bugs on today‚Äôs episode of <a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">TL;DR</a>, the JavaScript codecast series that teaches working web developers to craft exceptional software in 5 minutes a week.</p>
<iframe src="https://www.youtube.com/embed/N23mqZBP0kQ" allow="autoplay; encrypted-media" allowfullscreen width="16" height="9"></iframe>
<h3 id="transcript">Transcript</h3>
<p><a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">We just hit 100 subscribers</a>, and I want to thank you so much for watching, sharing and subscribing! This series is based on problems faced in real-world consulting projects, so each episode is designed to teach powerful patterns that save you and your team time. But that takes a lot of time! Each 5‚Äì7 minute episode takes around 30 hours from inception to release.</p>
<p>So I want to ask you to consider <a href="https://www.patreon.com/jonathanleemartin">supporting me on Patreon</a> so I can keep crafting great content that helps you craft exceptional code. Think of it as a pay-what-you-like screencast subscription.</p>
<p>Alright, on to today‚Äôs pattern.</p>
<p>When each line of code has to defend against previous lines, we‚Äôre left with a tangle of branching and flow control constructs, like if‚Ä¶else and early returns. This is especially tricky for error handling code, which can turn an otherwise docile function into a flow control nightmare.</p>
<p>Today we‚Äôre working on authentication middleware that‚Äôs taken from a chapter in my book, <a href="/books/">Functional Design Patterns for Express.js</a>. If you‚Äôre hopping into a Node backend and have loved the design-oriented approach we take on TL;DR, I encourage you to check it out.</p>
<p>We‚Äôre making authenticated HTTP requests to an Express backend and supplying a special token called a <a href="https://jwt.io/">JSON Web Token</a>. If you‚Äôre new to JWTs, think of them as the picture page of a passport: they encode details about the user, and are securely signed so the backend knows they‚Äôre authentic.</p>
<pre><code class="language-javascript">makeRequestWithToken('g00d_t0k3n');
// =&gt; '‚úÖ 200: Welcome to the backend.'
makeRequestWithToken('3mpt1_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
makeRequestWithToken('0ld_t0k3n');
// =&gt; üí• TokenExpiredError: jwt expired
makeRequestWithToken('f@k3_t0k3n');
// =&gt; üí• JsonWebTokenError: jwt malformed
</code></pre>
<p>As long as the token is valid, the backend lets us use any of its APIs. But if the token is missing some information, has expired, or has been tampered with, the backend halts the request in its tracks.</p>
<p>The function responsible for this guard behavior is a middleware function called <code>checkToken()</code>:</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let payload = jwt.verify(req.token, 's3cr3t');

  if (payload &amp;&amp; payload.user) {
    req.user = payload.user;
  } else {
    res.status(401).send('Bad token.');
    return;
  }

  next();
};
</code></pre>
<p>It tries to decode the contents of the JSON Web Token, called the payload. If the token is successfully decoded, it stores the user information on the request object and invokes <code>next()</code> to continue. But if the token is bad, it halts the request and immediately responds with a 401 Unauthorized status code.</p>
<p>But a lot of other things can go wrong. A client could supply an expired token, or they might tamper with it; in either case, the <code>jwt.verify()</code> function throws an exception. Right now, the <code>checkToken()</code> function is completely oblivious to these potential errors.</p>
<p>We should never allow a known exception to go uncaught, otherwise the backend‚Äôs response will just hang. So instead, we need to catch any JWT-related errors and respond with a 401 status code.</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
-  let payload = jwt.verify(req.token, 's3cr3t');
+  let payload;
+  try {
+    payload = jwt.verify(req.token, 's3cr3t');
+  } catch (error) {
+    /* Suppress the error */
+  }

   if (payload &amp;&amp; payload.user) {
     ...
 };

</code></pre>
<p>To do that, we can wrap try‚Ä¶catch around the <code>verify()</code> call. But as we learned in the last two episodes, an <a href="/tldr/04-custom-exceptions/">unqualified catch is almost always a bug</a>. We must only catch error types we intend to handle. We‚Äôll use an if‚Ä¶else statement to rethrow the error if it isn‚Äôt a <code>TokenExpiredError</code> or <code>JsonWebTokenError</code>.</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let payload;
  try {
    payload = jwt.verify(req.token, 's3cr3t');
  } catch (error) {
    if (error instanceof TokenExpiredError
     || error instanceof JsonWebTokenError) {
      /* Suppress the error */
    } else {
      throw error;
    }
  }

  if (payload &amp;&amp; payload.user) {
    req.user = payload.user;
  } else {
    res.status(401).send('Bad token.');
    return;
  }

  next();
};
</code></pre>
<pre><code class="language-javascript">makeRequestWithToken('g00d_t0k3n');
// =&gt; '‚úÖ 200: Welcome to the backend.'
makeRequestWithToken('3mpt1_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
makeRequestWithToken('0ld_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
makeRequestWithToken('f@k3_t0k3n');
// =&gt; 'üö´ 401: Bad token.'
</code></pre>
<p>This is the correct way to handle all these edge cases, but now <code>checkToken()</code> is swimming in flow control constructs: early returns, try‚Ä¶catch, throw, and an unhealthy dose of if‚Ä¶else statements too. And sadly, this style is typical of most popular middleware libraries.</p>
<p>Each line of code is constantly on guard, as though it can‚Äôt trust the lines before it. So how do we nuke these flow control constructs?</p>
<p><a href="/tldr/05-exception-composition">Last episode</a> we derived a helper called <code>swallow()</code> that could help. <code>swallow()</code> is a <a href="https://medium.com/javascript-scene/higher-order-functions-composing-software-5365cf2cbe99">higher-order function</a> that runs some code that could potentially blow up. If it does, it suppresses the error and instead returns the result of another function.</p>
<pre><code class="language-javascript">let swallow = (type) =&gt; (fail) =&gt; (fn) =&gt; (...args) =&gt; {
  try {
    return fn(...args);
  } catch (error) {
    if (!(error instanceof type)) { throw error; }
    return fail(error);
  }
};

let safeFindBlog = swallow(NotFound)(
  () =&gt; 'Missing blog'
)(unsafeFindBlog);

unsafeFindBlog({ id: 5 });
// =&gt; { title: 'I üòç JS' }
unsafeFindBlog({ id: 100 });
// =&gt; üí• NotFound
safeFindBlog({ id: 100 });
// =&gt; 'Missing blog'
</code></pre>
<p>Let‚Äôs try using <code>swallow()</code> in place of the try‚Ä¶catch and if‚Ä¶else statements. If <code>jwt.verify()</code> throws a <code>TokenExpiredError</code>, we‚Äôll catch it and instead return null to make it mirror the old behavior.</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let payload =
    swallow(TokenExpiredError)(
      () =&gt; null
    )(
      () =&gt; jwt.verify(req.token, 's3cr3t')
    )();

  if (payload &amp;&amp; payload.user) {
    ...
};
</code></pre>
<p>Since <code>swallow()</code> is a higher-order function, we can also catch a <code>JsonWebTokenError</code> by composing it with another <code>swallow()</code>.</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
   let payload =
+    swallow(JsonWebTokenError)(
+      () =&gt; null
+    )(
       swallow(TokenExpiredError)(
         () =&gt; null
       )(
         () =&gt; jwt.verify(req.token, 's3cr3t')
+      )
     )();

   if (payload &amp;&amp; payload.user) {
     ...
 };
</code></pre>
<p>This is horrible to read, but it behaves correctly and removed several flow control constructs. What about the remaining conditionals? It would help if we could go ahead and destructure the payload‚Äôs user property. Then the following code could be less defensive about the shape of payload.</p>
<p>Well if a <code>TokenExpiredError</code> is thrown, <code>swallow()</code> will return null, which isn‚Äôt an object and can‚Äôt be destructured. So what if instead of returning null, we returned a benign value that has the shape of a valid payload, such as an object with a user property? Then even if an exception is thrown, we can be sure that the payload will have the right shape.</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
-  let payload =
+  let { user } =
     swallow(JsonWebTokenError)(
-      () =&gt; null
+      () =&gt; ({ user: null })
     )(
       swallow(TokenExpiredError)(
-        () =&gt; null
+        () =&gt; ({ user: null })
       )(
         () =&gt; jwt.verify(req.token, 's3cr3t')
       )
     )();

-  if (payload &amp;&amp; payload.user) {
+  if (user) {
-    req.user = payload.user;
+    req.user = user;
   } else {
     ...
 };
</code></pre>
<p>By substituting a benign value as early as possible, we don‚Äôt have to be defensive later on. In Object-Oriented Programming, this benign value is called a <a href="https://en.wikipedia.org/wiki/Null_object_pattern">Null Object</a>. It‚Äôs often a subclass of the expected object type, and should respond to the same messages.</p>
<pre><code class="language-javascript">class User {
  constructor({ id, name, email }) {
    this.name = name;
    this.email = email;
    this.id = id || generateId();
  }
}

class NullUser extends User {
  constructor() {
    super({
      id: '00000000',
      name: 'NullUser',
      email: 'null@app.com'
    });
  }
}
</code></pre>
<p>Since we‚Äôre taking a more functional approach, we won‚Äôt create a Null Object class, but we can still lift this Null Object into a variable called <code>nullPayload</code> to better communicate intent.</p>
<pre><code class="language-javascript">let nullPayload = { user: null };
</code></pre>
<p>I use this pattern so often, I like to create a utility called <code>rescueWith()</code> that behaves exactly like <code>swallow()</code>, except that we don‚Äôt need the extra function wrapping around the <code>nullPayload</code>.</p>
<pre><code class="language-javascript">let rescueWith = (type) =&gt; (fallback) =&gt;
  swallow(type)(() =&gt; fallback);

let checkToken = (req, res, next) =&gt; {
  let { user } =
    rescueWith(JsonWebTokenError)(nullPayload)(
      rescueWith(TokenExpiredError)(nullPayload)(
        () =&gt; jwt.verify(req.token, 's3cr3t')
      )
    )();

  if (user) {
    ...
};
</code></pre>
<p>That helps cut down the syntactic noise, and once we move the arguments for <code>jwt.verify()</code> to the end:</p>
<pre><code class="language-javascript">let checkToken = (req, res, next) =&gt; {
  let { user } =
    rescueWith(JsonWebTokenError)(nullPayload)(
      rescueWith(TokenExpiredError)(nullPayload)(
        jwt.verify
      )
    )(req.token, 's3cr3t');

  if (user) {
    ...
</code></pre>
<p>We now see the entire function can be extracted from <code>checkToken()</code> altogether! Let‚Äôs call it <code>safeVerifyJWT</code> since it works exactly like <code>jwt.verify()</code> but just replaces errors with a safe value.</p>
<pre><code class="language-javascript">let safeVerifyJWT =
  rescueWith(JsonWebTokenError)(nullPayload)(
    rescueWith(TokenExpiredError)(nullPayload)(
      jwt.verify
    )
  );

let checkToken = (req, res, next) =&gt; {
  let { user } = safeVerifyJWT(req.token, 's3cr3t');

  if (user) {
    ...
</code></pre>
<p>Finally, let‚Äôs whip out our <code>compose()</code> helper to remove the nesting.</p>
<pre><code class="language-javascript">let safeVerifyJWT = compose(
  rescueWith(JsonWebTokenError)(nullPayload),
  rescueWith(TokenExpiredError)(nullPayload),
)(jwt.verify);
</code></pre>
<p>This refactor has helped us discover the boundary we should have seen all along: all that try‚Ä¶catch and if‚Ä¶else nonsense was just about making a version of <code>jwt.verify()</code> that behaved a little differently ‚Äî just the sort of thing higher-order functions do so well.</p>
<p>And now <code>checkToken()</code> is back to focusing on the naive happy path. With all the noise out of the way, we can confidently reason that <code>next()</code> will only be called if there‚Äôs a user, so we can move it into the if clause and eliminate the early return in the else. This code now has zero flow control constructs!</p>
<pre><code class="language-diff"> let checkToken = (req, res, next) =&gt; {
   let { user } = safeVerifyJWT(req.token, 's3cr3t');

   if (user) {
     req.user = user;
+    next();
   } else {
     res.status(401).send('Bad token.');
-    return;
   }

-  next();
 };
</code></pre>
<p>Optionally, we can even rewrite the remaining if‚Ä¶else statement into <a href="/tldr/01-nested-ternaries/">a ternary expression</a> to prohibit any flow control constructs at all. But whether or not you use the ternary, the final <code>checkToken()</code> function reads nicely thanks to small, well-behaved functions and a predictable flow.</p>
<pre><code class="language-javascript">let nullPayload = { user: null };

let safeVerifyJWT = compose(
  rescueWith(JsonWebTokenError)(nullPayload),
  rescueWith(TokenExpiredError)(nullPayload),
)(jwt.verify);

let checkToken = (req, res, next) =&gt; {
  let { user } = safeVerifyJWT(req.token, 's3cr3t');

  return user
    ? (req.user = user, next())
    : res.status(401).send('Bad token.');
};
</code></pre>
<p>We‚Äôve been building up to this refactor for a few episodes, but by letting things get ugly instead of skipping directly to <code>rescueWith()</code>, we saw how composition always wins in the end ‚Äî even if the process seems to produce more code.</p>
<p>And that journey helped us identify and solve the underlying problem: trust. Each line of code was defensive because it couldn‚Äôt safely trust the results of lines before it. With this variation of the Null Object Pattern, we replaced edge cases with benign values. Once we did that, the boundaries became detangled so we could extract a safe version of <code>jwt.verify()</code>.</p>
<p>Trust is a powerful refactoring tool. Today, look for try‚Ä¶catch statements, followed by if‚Ä¶else statements, and use the Null Object Pattern and <code>rescueWith()</code> to restore a culture of trust.</p>
<p>That‚Äôs it for today! If you loved today‚Äôs episode, please consider <a href="https://www.patreon.com/jonathanleemartin">supporting the channel on Patreon</a>. Want to keep leveling up your craft? Don‚Äôt forget to <a href="https://www.youtube.com/channel/UCol-gOYBawJGqUn2AhwxhNg">subscribe to the channel</a> for more rapid codecasts on design patterns, refactoring and development approaches.</p>
<!--kg-card-end: markdown-->
            </div>
          </div>
        </div>
        <section class="m-subscribe-section">
          <div class="l-wrapper in-post">
            <div class="m-subscribe-section__content">
              <div class="m-subscribe-section__text">
                <h4 class="m-subscribe-section__title">Keep leveling up your craft</h4>
                <p class="m-subscribe-section__description">
                  Subscribe for (infrequent) digests of new content to help you¬†craft exceptional code.
                </p>
              </div>
              <div class="m-subscribe-section__form">
                
<form method="post" action="https://jonathanleemartin.us4.list-manage.com/subscribe/post?u=06192382d0d99bb3a3f789d30&amp;id=cb60b1e5bb" id="subscribe-form" class="m-subscribe-section__form">
  <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

  <fieldset>
    <label for="EMAIL" class="sr-only">Your email address</label>
    <input id="EMAIL" name="EMAIL" class="m-input in-subscribe-section" placeholder="Your email address" value="" >
  </fieldset>
  <button id="subscribe_button" class="m-button primary block" type="submit">Subscribe</button>

  
<script>
    (function(g,h,o,s,t){
        var buster = function(b,m) {
            h[o]('input.'+b).forEach(function (i) {
                i.value=i.value || m;
            });
        };
        buster('location', g.location.href);
        buster('referrer', h.referrer);
    })(window,document,'querySelectorAll','value');
</script>


</form>

              </div>
            </div>
          </div>
        </section>
        <section class="m-author">
          <div class="m-author__content">
            <div class="m-author__picture">
              <a href="/author/jonathan/" class="m-author-picture" aria-label="Author picture">
                <div style="background-image: url(//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x);"></div>
              </a>
            </div>
            <div class="m-author__info">
              <h4 class="m-author__name">
                <a href="/author/jonathan/">Jonathan Lee Martin</a>
              </h4>
              <p class="m-author__bio">Jonathan is an educator, writer and international speaker. He guides developers ‚Äî from career switchers to senior developers at Fortune 100 companies ‚Äî through their journey into web development.</p>
              <ul class="m-author-links">
                <li>
                  <a href="https://jonathanleemartin.com/" target="_blank" rel="noopener" aria-label="Website">
                    <span class="icon-globe"></span>
                  </a>
                </li>
                <li>
                  <a href="https://facebook.com/yellowscale" target="_blank" rel="noopener" aria-label="Facebook">
                    <span class="icon-facebook"></span>
                  </a>
                </li>
                <li>
                  <a href="https://twitter.com/nybblr" target="_blank" rel="noopener" aria-label="Twitter">
                    <span class="icon-twitter"></span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </section>
        <section class="m-recommended">
          <div class="l-wrapper in-recommended">
            <h3 class="m-section-title in-recommended">Recommended for you</h3>
            <div class="m-recommended-articles">
              <div class="m-recommended-slider js-recommended-articles">
                
    <div class="m-recommended-slider__item">
    <article class="m-article-card post tag-tldr tag-javascript tag-design-pattern tag-web tag-react tag-node">
      <div class="m-article-card__picture" style="background-image: url(/content/images/2019/09/02-router-pattern-1.png);">
      <a href="/tldr/02-router-pattern/" class="m-article-card__picture-link" aria-label="Article"></a>
      <a href="/author/jonathan/" class="m-article-card__author js-tooltip" aria-label="Authors" data-tippy-content="Posted by Jonathan Lee Martin ">
          <div style="background-image: url(//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="/tag/tldr/" class="m-article-card__tag">tl;dr</a>
      <a href="/tldr/02-router-pattern/" class="m-article-card__info-link">
        <div class="m-article-card__excerpt">
          <h2 class="m-article-card__title">02. Router Pattern</h2>
          <p class="m-article-card__description">üé¨ How do you tame if-else or switch statements that grow with every feature request? üò¨ Let the Router design pattern turn your code inside out!</p>
        </div>
        <div class="m-article-card__timestamp">
          <span>September 18, 2019</span>
          <span>&bull;</span>
          <span>6 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
    <div class="m-recommended-slider__item">
    <article class="m-article-card post tag-tldr tag-javascript tag-design-pattern tag-web tag-react">
      <div class="m-article-card__picture" style="background-image: url(/content/images/2019/10/03-enforcers.png);">
      <a href="/tldr/03-enforcer-pattern/" class="m-article-card__picture-link" aria-label="Article"></a>
      <a href="/author/jonathan/" class="m-article-card__author js-tooltip" aria-label="Authors" data-tippy-content="Posted by Jonathan Lee Martin ">
          <div style="background-image: url(//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="/tag/tldr/" class="m-article-card__tag">tl;dr</a>
      <a href="/tldr/03-enforcer-pattern/" class="m-article-card__info-link">
        <div class="m-article-card__excerpt">
          <h2 class="m-article-card__title">03. Enforcer Pattern</h2>
          <p class="m-article-card__description">üé¨ Find yourself copy-pasting small if-else statements across several functions? üíÇ‚Äç‚ôÇÔ∏è With higher-order functions and the enforcer pattern, you can compose guard behaviors!</p>
        </div>
        <div class="m-article-card__timestamp">
          <span>October 9, 2019</span>
          <span>&bull;</span>
          <span>7 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
    <div class="m-recommended-slider__item">
    <article class="m-article-card post tag-tldr tag-javascript tag-design-pattern tag-web">
      <div class="m-article-card__picture" style="background-image: url(/content/images/2019/10/05-exception-composition.png);">
      <a href="/tldr/05-exception-composition/" class="m-article-card__picture-link" aria-label="Article"></a>
      <a href="/author/jonathan/" class="m-article-card__author js-tooltip" aria-label="Authors" data-tippy-content="Posted by Jonathan Lee Martin ">
          <div style="background-image: url(//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="/tag/tldr/" class="m-article-card__tag">tl;dr</a>
      <a href="/tldr/05-exception-composition/" class="m-article-card__info-link">
        <div class="m-article-card__excerpt">
          <h2 class="m-article-card__title">05. Exception Composition</h2>
          <p class="m-article-card__description">üé¨ How do you safely handle runtime errors without a mess of try‚Ä¶catch and if‚Ä¶else? üò∑ Why, function composition of course!</p>
        </div>
        <div class="m-article-card__timestamp">
          <span>October 23, 2019</span>
          <span>&bull;</span>
          <span>5 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </article>
  </main>
</div>



    
<div class="m-search js-search">
  <button class="m-icon-button outlined as-close-search js-close-search" aria-label="Close search">
    <span class="icon-close"></span>
  </button>
  <div class="m-search__content">
    <form class="m-search__form">
      <fieldset>
        <span class="icon-search m-search-icon"></span>
        <input type="text" class="m-input in-search js-input-search" placeholder="Type to search" aria-label="Type to search">
      </fieldset>
    </form>
    <div class="js-search-results"></div>
  </div>
</div>

    
<footer class="m-footer">
  <div class="m-footer__content">
    <p class="m-footer-copyright">
      <span>tl;dr &copy; 2019</span>
      <span>&nbsp; &bull; &nbsp;</span>
      <span>By <a href="https://jonathanleemartin.com/" target="_blank" rel="noopener">Jonathan Lee Martin</a></span>
    </p>
    <nav class="m-footer-social">
        <a href="https://www.facebook.com/yellowscale" target="_blank" rel="noopener" aria-label="Facebook">
          <span class="icon-facebook"></span>
        </a>
        <a href="https://twitter.com/nybblr" target="_blank" rel="noopener" aria-label="Twitter">
          <span class="icon-twitter"></span>
        </a>
    </nav>
  </div>
</footer>

    <script defer src="/assets/js/manifest.js"></script>
    <script defer src="/assets/js/polyfill.js"></script>
    <script defer src="/assets/js/vendor.js"></script>
    <script defer src="/assets/js/app.js"></script>

      <script defer src="/assets/js/post.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script>Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/components/';</script>


    <style type="text/css">
.mc-banner iframe {
  height: auto !important;
}
</style>
<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"06192382d0d99bb3a3f789d30","lid":"cb60b1e5bb","uniqueMethods":true}) })</script>
  </body>
</html>
