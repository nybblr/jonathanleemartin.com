<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">

    <title>To Kill -9 a Drone, Part 2</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <meta name="description" content="Jonathan Martin dives into the Parrot Rolling Spider quadcopter with virtual machines and the Linux Bluetooth stack." />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://www.bignerdranch.com/blog/to-kill-9-a-drone-daemon-part-2/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="tl;dr" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="To Kill -9 a Drone, Part 2" />
    <meta property="og:description" content="Last time, we took a tour of TTYs and serial connections to shell into the Linux-powered Parrot Rolling Spider quadcopter. This time, we’ll telnet in over Bluetooth." />
    <meta property="og:url" content="https://www.bignerdranch.com/blog/to-kill-9-a-drone-daemon-part-2/" />
    <meta property="article:published_time" content="2015-07-10T12:00:00.000Z" />
    <meta property="article:modified_time" content="2019-08-09T16:07:07.000Z" />
    <meta property="article:publisher" content="https://www.facebook.com/yellowscale" />
    <meta property="article:author" content="https://www.facebook.com/yellowscale" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="To Kill -9 a Drone, Part 2" />
    <meta name="twitter:description" content="Last time, we took a tour of TTYs and serial connections to shell into the Linux-powered Parrot Rolling Spider quadcopter. This time, we’ll telnet in over Bluetooth." />
    <meta name="twitter:url" content="https://www.bignerdranch.com/blog/to-kill-9-a-drone-daemon-part-2/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Lee Martin" />
    <meta name="twitter:site" content="@nybblr" />
    <meta name="twitter:creator" content="@nybblr" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "tl;dr",
        "logo": {
            "@type": "ImageObject",
            "url": "https://jonathanleemartin.com/content/images/2019/08/logo.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Jonathan Lee Martin",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://jonathanleemartin.com/author/jonathan/",
        "sameAs": [
            "https://jonathanleemartin.com/",
            "https://www.facebook.com/yellowscale",
            "https://twitter.com/nybblr"
        ]
    },
    "headline": "To Kill -9 a Drone, Part 2",
    "url": "https://jonathanleemartin.com/blog/to-kill-9-a-drone-part-2/",
    "datePublished": "2015-07-10T12:00:00.000Z",
    "dateModified": "2019-08-09T16:07:07.000Z",
    "description": "Last time, we took a tour of TTYs and serial connections to shell into the Linux-powered Parrot Rolling Spider quadcopter. This time, we’ll telnet in over Bluetooth.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jonathanleemartin.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.27" />
    <link rel="alternate" type="application/rss+xml" title="tl;dr" href="https://jonathanleemartin.com/rss/" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="https://jonathanleemartin.com">tl;dr</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">To Kill -9 a Drone, Part 2</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/jonathan/">Jonathan Lee Martin</a></p>
                    <time class="post-date" datetime="2015-07-10">2015-07-10</time>
                </section>
            </header>
            <section class="post-content">

                <p><small><em>This post first appeared on the <a href="https://www.bignerdranch.com/blog/to-kill-9-a-drone-daemon-part-2/">Big Nerd Ranch blog</a>.</em></small></p>
<p><em>Last time, <a href="https://www.bignerdranch.com/blog/to-kill-9-a-drone-daemon-part-1/">we took a tour of TTYs and serial connections</a> to shell into the Linux-powered <a href="http://www.parrot.com/usa/products/rolling-spider/">Parrot Rolling Spider quadcopter</a>. This time, we’ll telnet in over Bluetooth.</em></p>
<p>Before stumbling upon the USB method for shelling into my drone, I noticed that my drone didn’t shut down after 60 seconds if a Bluetooth device was connected. A fleeting glance at <code>/etc/init.d/rcS</code> revealed calls to <code>telnetd</code> and <code>BLEproxy</code>.</p>
<p><code>telnet</code> opens a shell session over TCP/IP, usually over a WiFi or Ethernet connection. However, the Rolling Spider is not equipped with WiFi, so why the references to networking? I hypothesized that a lot of the mini-drone's software is based on the WiFi-equipped <a href="http://ardrone2.parrot.com/">AR.Drone</a>, which receives flight commands over UDP/TCP.</p>
<p>To keep the software reusable on the Rolling Spider, <code>BLEproxy</code> might set up a <a href="https://en.wikipedia.org/wiki/List_of_Bluetooth_protocols#Bluetooth_network_encapsulation_protocol_.28BNEP.29">bnep</a> network interface, which would allow me to control to the Rolling Spider on <code>192.168.1.1</code>, just like the AR.Drone. To that end, I'll establish a <a href="https://en.wikipedia.org/wiki/List_of_Bluetooth_profiles#Personal_Area_Networking_Profile_.28PAN.29">PAN</a> network with the drone so that I can open UDP/TCP connections through the bnep interface. Since <code>telnetd</code> is listening on port 23, I should be able shell to the drone over Bluetooth.</p>
<p>But first things first: <strong>I need a computer with Bluetooth set up.</strong></p>
<h2 id="bluetoothonosx">Bluetooth on OS X</h2>
<p>Like most of my colleagues, I use a Mac. The BSD flavor of UNIX is great for day-to-day development, but the tooling differs drastically from a Linux stack.</p>
<p>Bluetooth is no exception: on Mac, there are few (i.e., zilch) terminal utilities for working with OS X’s Bluetooth stack. Linux, however, is well-stocked with open-source tools to configure Bluetooth and network interfaces, thanks to the <a href="http://www.bluez.org/">BlueZ</a> stack. The generous assemblage of blog and forum posts is especially crucial for wading through nondescript errors.</p>
<h2 id="linuxvm1debian">Linux VM #1: Debian</h2>
<p>Rather than build a Linux computer from scratch, I’ll run a virtual machine with <a href="https://www.virtualbox.org/">Virtual Box</a>. Still, it takes a couple hours to spin up the machine, install the OS and install guest additions. Maybe some scripts could save me some time?</p>
<p>Enter <a href="https://www.vagrantup.com/">Vagrant</a>: it makes spinning up a VM a snap by downloading and setting up common VM configurations for you. Most folks use it to set up a consistent staging environment, but it also works great for quickly setting up a Linux box with shell access.</p>
<p>There are plenty of <a href="https://atlas.hashicorp.com/boxes/search">VM templates to choose from</a>; for entirely arbitrary reasons, I decide to spin up a Debian 7.6 machine:</p>
<pre><code>$ vagrant init chef/debian-7.6
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==&gt; default: Box 'chef/debian-7.6' could not be found. Attempting to find and install...
    default: Box Provider: virtualbox
    default: Box Version: &gt;= 0
==&gt; default: Loading metadata for box 'chef/debian-7.6'
    default: URL: https://atlas.hashicorp.com/chef/debian-7.6
==&gt; default: Adding box 'chef/debian-7.6' (v1.0.0) for provider: virtualbox
    default: Downloading: https://atlas.hashicorp.com/chef/boxes/debian-7.6/versions/1.0.0/providers/virtualbox.box
==&gt; default: Successfully added box 'chef/debian-7.6' (v1.0.0) for 'virtualbox'!
==&gt; default: Importing base box 'chef/debian-7.6'...
==&gt; default: Matching MAC address for NAT networking...
==&gt; default: Checking if box 'chef/debian-7.6' is up to date...
==&gt; default: Setting the name of the VM: drone_default_1435939856993_21528
==&gt; default: Clearing any previously set network interfaces...
==&gt; default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==&gt; default: Forwarding ports...
    default: 22 =&gt; 2222 (adapter 1)
==&gt; default: Booting VM...
==&gt; default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default:
    default: Vagrant insecure key detected. Vagrant will automatically replace
    default: this with a newly generated keypair for better security.
    default:
    default: Inserting generated public key within guest...
    default: Removing insecure key from the guest if its present...
    default: Key inserted! Disconnecting and reconnecting using new SSH key...
==&gt; default: Machine booted and ready!
==&gt; default: Checking for guest additions in VM...
==&gt; default: Mounting shared folders...

$ vagrant halt
==&gt; default: Attempting graceful shutdown of VM...
</code></pre>
<p>Three minutes later, I have a ready-to-go Debian instance. Next, I need to give the VM access to my MacBook's internal Bluetooth card. Guest Additions need to be installed for the VM to recognize various hardware devices, but this Debian VM template already has it installed. So I simply need to enable the USB 2.0 controller and add my Bluetooth card:</p>
<p></p>
<p>Just to make sure the hardware settings work, I start up the VM directly in VirtualBox rather than using Vagrant's CLI. It boots into a shell, so I log in with username <code>vagrant</code> and password <code>vagrant</code>. Now for the hardware: my Bluetooth card shows up in the list of available USB Devices:</p>
<p></p>
<p>Time to mount my Bluetooth USB device to the Debian VM:</p>
<p></p>
<h2 id="reclaimingbluetooth">Reclaiming Bluetooth</h2>
<p>Uh oh! For the virtual machine to use Bluetooth, it needs to have the device all to itself, but the host OS is using it. Turning off Bluetooth in OS X won't suffice: I need to <code>kill -9</code> the <code>blued</code> process on my Mac, but it regenerates itself every time. For <code>blued</code> to really die, it needs to be unloaded with <code>launchctl</code>:</p>
<pre><code>$ sudo launchctl unload /System/Library/LaunchDaemons/com.apple.blued.plist
</code></pre>
<p>That's still not quite enough: some kernel extensions (KEXT) are holding on. Let's search all the loaded KEXTs for those relating to Bluetooth:</p>
<pre><code>$ kextstat -l | awk '{gsub(/^ +| +$/,"")}1' |  tr -s ' ' | cut -f6 -d ' ' | grep Bluetooth
com.apple.iokit.IOBluetoothFamily
com.apple.iokit.IOBluetoothHostControllerUSBTransport
com.apple.iokit.BroadcomBluetoothHostControllerUSBTransport
com.apple.iokit.IOBluetoothSerialManager
</code></pre>
<p>The third item <code>BroadcomBluetoothHostControllerUSBTransport</code> looks pertinent, maybe unloading it will free up the Bluetooth device:</p>
<pre><code>$ sudo kextunload -b com.apple.iokit.BroadcomBluetoothHostControllerUSBTransport
</code></pre>
<p>Success! Now when we try to connect the Bluetooth controller to Virtual Box, it doesn't give any errors. Let's shut down the VM and start it up from Vagrant now:</p>
<pre><code>$ vagrant up
[ lots of output ]
$ vagrant ssh
vagrant@packer-debian-7:~$
</code></pre>
<p>Just to make sure, I'll use <code>lsusb</code> to see if the Linux VM recognizes my Bluetooth controller:</p>
<pre><code>$ sudo apt-get update
$ sudo apt-get install usbutils
$ lsusb
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 002 Device 002: ID 05ac:8286 Apple, Inc.
</code></pre>
<p>The output is stripped of pleasantries, but that last device has Apple's manufacturer ID (05ac), so it must be the Bluetooth controller. I'm ready to install the BlueZ stack:</p>
<pre><code>$ sudo apt-get install bluez bluez-utils bluez-compat
</code></pre>
<p>Next up, I need to tell Linux what Bluetooth device to use.</p>
<pre><code>$ hciconfig
Can't open HCI socket.: Address family not supported by protocol
</code></pre>
<p>What’s going on? The Linux kernel is super modular and made of many low-level modules. Most device drivers (like USB and Ethernet) are just Linux modules, including Bluetooth. So, does our Linux kernel have a Bluetooth module?</p>
<pre><code>$ lsmod | grep bluetooth
[ nothing :-( ]
</code></pre>
<p>Nope! Debian 7.6's version of the Linux kernel doesn’t support the Bluetooth module.</p>
<h2 id="linuxvm2debianagain">Linux VM #2: Debian Again</h2>
<p>Time for an upgrade: I'll rinse and repeat the setup steps with a more recent Debian:</p>
<pre><code>$ vagrant init chef/debian-7.8
$ vagrant up
$ vagrant halt
</code></pre>
<p>After running the rest of the commands, I can double check kernel support:</p>
<pre><code>$ lsmod | grep bluetooth
bluetooth             119455  1 btusb
rfkill                 19012  1 bluetooth
crc16                  12343  2 ext4,bluetooth
</code></pre>
<p>That looks much more promising! This kernel is built with the Bluetooth module. Let's try <code>hcitool</code>:</p>
<pre><code>$ hcitool dev
Devices:
        hci0    28:CF:E9:21:6C:1A
</code></pre>
<p>Great! Linux recognizes my Bluetooth device. I need to set up the device on every reboot:</p>
<pre><code>$ sudo hciconfig hci0 up
</code></pre>
<p>Now I should be able to scan for Bluetooth Low Energy devices. Turn my little drone on, and...</p>
<pre><code>$ sudo hcitool lescan
LE Scan ...
9E:08:00:AC:0B:19 RS_R112233
9E:08:00:AC:0B:19 (unknown)
</code></pre>
<p>It's alive, but all is not well. When I try to connect to the drone with <code>sudo hcitool lecc</code> or <code>gatttool</code>, it fails with a <code>Host is down (112)</code> message. Maybe <a href="https://stackoverflow.com/questions/24853597/ble-gatttool-cannot-connect-even-though-device-is-discoverable-with-hcitool-lesc">BLE support in my old version of BlueZ is buggy</a>?</p>
<p>BlueZ is currently version 5.30, but why is Debian 7.8 bundled with BlueZ 4? The BlueZ 5 API diverges drastically from BlueZ 4, so it takes a fair amount of effort to upgrade apps. Coupled with the shockingly poor documentation, very few Linux distributions have successfully upgraded to BlueZ 5.</p>
<p>I initially built BlueZ 5.30 from source, but a few binaries are missing, so I'll install BlueZ 5.23 from the <a href="https://wiki.debian.org/InstallFAQ#Q._How_do_I_install_.22unstable.22_.28.22sid.22.29.3F">Debian Unstable package source</a>.</p>
<p>As part of major refactors, BlueZ 5 directs all commands to the <code>bluetoothd</code> daemon over <a href="https://en.wikipedia.org/wiki/D-Bus">D-Bus</a>. To send commands from the terminal, I can run <code>bluetoothctl</code>:</p>
<pre><code>$ sudo bluetoothctl
[bluetooth]#
</code></pre>
<p>I get a REPL, but it just hangs. Maybe <code>bluetoothd</code> isn't listening?</p>
<pre><code>$ ps aux | grep bluetoothd
[ nothing :( ]
</code></pre>
<p>Doh, <code>bluetoothd</code> isn't even running! I'll run it myself in no-detach mode:</p>
<pre><code>$ sudo bluetoothd -n
bluetoothd[4440]: Bluetooth daemon 5.14
bluetoothd[4440]: Failed to access management interface
bluetoothd[4440]: Adapter handling initialization failed

$ uname -r
3.2.0-4-amd64
</code></pre>
<p>How embarrassing—our Linux kernel is still too old! BlueZ 5 requires a kernel version &gt;= 3.4 to support the new Bluetooth Management kernel interface, and &gt;= 3.5 for BLE support!</p>
<p>Maybe it's time for a third Linux distribution?</p>
<h2 id="linuxvm3ubuntu">Linux VM #3: Ubuntu</h2>
<p>This time, I'll pick a recent distribution: Ubuntu 14.04 LTS. It ships with version 3.13 of the Linux kernel. After repeating all the setup commands I ran on the Debian distros, things seem to be in order:</p>
<pre><code>$ lsusb
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 002: ID 05ac:8286 Apple, Inc. Bluetooth Host Controller
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
</code></pre>
<p>The BlueZ version for Ubuntu is still too old, but thankfully <a href="https://launchpad.net/~vidplace7/+archive/ubuntu/bluez5">another package source</a> has the latest builds. I'll add it to my apt-get sources:</p>
<pre><code>$ echo "deb http://ppa.launchpad.net/vidplace7/bluez5/ubuntu trusty main" &gt;&gt; /etc/apt/sources.list
$ sudo apt-get install bluez
$ bluetoothctl -v
5.30
</code></pre>
<p>I'm definitely running BlueZ 5.30, time to see if <code>bluetoothd</code> started up:</p>
<pre><code>$ sudo bluetoothctl
[NEW] Controller 28:CF:E9:21:6C:1A vagrant [default]
[bluetooth]#
</code></pre>
<p>Looks like I have working a Bluetooth setup!</p>
<h2 id="panningfornetworks">PANning for Networks</h2>
<p>With Bluetooth working correctly on my VM, I am ready to set up a <a href="https://en.wikipedia.org/wiki/Personal_area_network#Bluetooth">PAN</a> with my drone. BlueZ 4 includes a utility called <code>pand</code> that does just this, but in BlueZ 5 I have to code up my own script. Since everything happens over D-Bus, I can write a Python script to initiate a PAN. Thankfully, <a href="https://github.com/mk-fg/fgtk/blob/master/bt-pan">Mike Kazantsev has already written that script</a>.</p>
<pre><code>$ wget https://github.com/mk-fg/fgtk/raw/master/bt-pan
$ chmod +x bt-pan
$ sudo apt-get install python-dbus
</code></pre>
<p>The <code>bt-pan</code> script is a modified version of the <code>test-network</code> script bundled with BlueZ 5. It instructs the <code>bluetoothd</code> to create a new network interface called <code>bnep0</code>. I need to grab the MAC address of my drone, then feed that into the script:</p>
<pre><code>$ sudo hcitool lescan
LE Scan ...
9E:08:00:AC:0B:19 RS_R112233
9E:08:00:AC:0B:19 (unknown)

$ sudo ./bt-pan -u panu client 9E:08:00:AC:0B:19
Traceback (most recent call last):
  File "./bt-pan", line 207, in &lt;module&gt;
    if __name__ == '__main__': sys.exit(main())
  File "./bt-pan", line 180, in main
    try: iface = net.Connect(opts.uuid)
  File "/usr/lib/python2.7/dist-packages/dbus/proxies.py", line 145, in __call__
    **keywords)
  File "/usr/lib/python2.7/dist-packages/dbus/connection.py", line 651, in call_blocking
    message, timeout)
dbus.exceptions.DBusException: org.freedesktop.DBus.Error.UnknownMethod: Method "Connect" with signature "s" on interface "org.bluez.Network1" doesn't exist
</code></pre>
<p>A D-Bus issue? After all that work, it turns out that the PAN interface <code>Network1</code> is not available. This isn't a spurious failure: Bluetooth Low Energy doesn't support the PAN profile, so <code>Network1</code> is never exposed on the D-Bus interface. Only regular Bluetooth supports PAN!</p>
<h2 id="nexttime">Next time...</h2>
<p>To my disappointment, we aren't quite to the point of <code>telnet</code>ing into the drone. But never fear! In Part 3, we will backtrack to another clue in <code>/etc/init.d/rcS</code> to complete our journey of wirelessly shelling into the mini-drone.</p>


            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://jonathanleemartin.com">tl;dr</a> &copy; 2019</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
