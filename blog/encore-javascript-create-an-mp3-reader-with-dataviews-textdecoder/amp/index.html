<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">

    <title>Encore, JavaScript! Create an MP3 reader with DataViews + TextDecoder.</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <meta name="description" content="Learn to parse MP3 metadata with JavaScript’s ArrayBuffers, DataViews, TypedArrays and TextDecoder to create an MP3 player that works in the browser." />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://www.bignerdranch.com/blog/encore-javascript-create-an-mp3-reader-with-dataviews-textdecoder/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="tl;dr" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Encore, JavaScript! Create an MP3 reader with DataViews + TextDecoder." />
    <meta property="og:description" content="Now Playing: Learn to parse MP3 metadata with JavaScript’s ArrayBuffers, DataViews, TypedArrays and TextDecoder." />
    <meta property="og:url" content="https://www.bignerdranch.com/blog/encore-javascript-create-an-mp3-reader-with-dataviews-textdecoder/" />
    <meta property="article:published_time" content="2017-03-23T12:00:00.000Z" />
    <meta property="article:modified_time" content="2019-08-09T16:04:11.000Z" />
    <meta property="article:tag" content="JavaScript" />
    
    <meta property="article:publisher" content="https://www.facebook.com/yellowscale" />
    <meta property="article:author" content="https://www.facebook.com/yellowscale" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Encore, JavaScript! Create an MP3 reader with DataViews + TextDecoder." />
    <meta name="twitter:description" content="Now Playing: Learn to parse MP3 metadata with JavaScript’s ArrayBuffers, DataViews, TypedArrays and TextDecoder." />
    <meta name="twitter:url" content="https://www.bignerdranch.com/blog/encore-javascript-create-an-mp3-reader-with-dataviews-textdecoder/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Lee Martin" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="JavaScript" />
    <meta name="twitter:site" content="@nybblr" />
    <meta name="twitter:creator" content="@nybblr" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "tl;dr",
        "logo": {
            "@type": "ImageObject",
            "url": "https://jonathanleemartin.com/content/images/2019/08/logo.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Jonathan Lee Martin",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://jonathanleemartin.com/author/jonathan/",
        "sameAs": [
            "https://jonathanleemartin.com/",
            "https://www.facebook.com/yellowscale",
            "https://twitter.com/nybblr"
        ]
    },
    "headline": "Encore, JavaScript! Create an MP3 reader with DataViews + TextDecoder.",
    "url": "https://jonathanleemartin.com/blog/encore-javascript-create-an-mp3-reader-with-dataviews-textdecoder/",
    "datePublished": "2017-03-23T12:00:00.000Z",
    "dateModified": "2019-08-09T16:04:11.000Z",
    "keywords": "JavaScript",
    "description": "Now Playing: Learn to parse MP3 metadata with JavaScript’s ArrayBuffers, DataViews, TypedArrays and TextDecoder.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jonathanleemartin.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.27" />
    <link rel="alternate" type="application/rss+xml" title="tl;dr" href="" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="https://jonathanleemartin.com">tl;dr</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Encore, JavaScript! Create an MP3 reader with DataViews + TextDecoder.</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/jonathan/">Jonathan Lee Martin</a></p>
                    <time class="post-date" datetime="2017-03-23">2017-03-23</time>
                </section>
            </header>
            <section class="post-content">

                <p><small><em>This post first appeared on the <a href="https://www.bignerdranch.com/blog/encore-javascript-create-an-mp3-reader-with-dataviews-textdecoder/">Big Nerd Ranch blog</a>.</em></small></p>
<p><em>Check out the <a href="https://github.com/nybblr/mp3-reader">finished code on Github</a>.</em></p>
<p>Like all good blog posts, this one started with a <a href="https://twitter.com/nybblr/status/833770058291765248">conversation on Twitter</a>. Giovanni Cortés showed off an elegant snippet of Elixir code that leverages destructuring to parse the song metadata (title, author, etc.) from an MP3 audio file.</p>
<p>About this time I was brainstorming new topics for <a href="https://jonathanleemartin.com/books/front-end-web-development/">our web development guide</a> about JavaScript’s high-performance data types. Although JavaScript’s destructuring isn’t as extensive as Elixir’s, it has great APIs for efficiently operating on large chunks of binary data.</p>
<p>While reading the tweet, I was also enjoying my favorite orchestral piece—<em>Snöfrid,</em> a beautiful melodrama by the Finnish composer Jean Sibelius—over coffee. So what could be more appropriate during a caffeine high amongst Scandinavian decor than to create an MP3 metadata reader with JavaScript?</p>
<h2 id="gettingstarted">Getting Started</h2>
<p>To compose this masterpiece, we will use some standardized APIs available in both the browser and Node. For simplicity we will build a command-line tool with Node, but apart from reading in a file, the code will run as is in the browser!</p>
<p>MP3 metadata, like the song’s title and composer, is stored in a format called <strong>“ID3”</strong> at the beginning (or end) of an MP3 file. We’ll just pretend it stands for “MP3 information” since the acronym’s true origins seem mysterious.</p>
<p>There are several revisions of the ID3 spec. Giovanni’s lovely Elixir example extracts <a href="http://id3.org/ID3v1">ID3v1 metadata</a> (called “TAG”) from an MP3 file. The TAG spec is incredibly straightforward to parse since it uses fixed length fields. Unfortunately, it turned out to be too simplistic, so most of the MP3s in your music library use the much more flexible (and complex) <a href="http://id3.org/id3v2.3.0">ID3v2.3.0 spec</a>. This version supports arbitrary length metadata and internationalization via alternate text encodings.</p>
<p>If you’re interested in seeing an ID3v1 reader, <a href="https://ericbidelman.tumblr.com/post/8343485440/reading-mp3-id3-tags-in-javascript">check out this implementation by Eric Bidelman</a>. His example uses the <a href="https://github.com/jDataView/jDataView">jDataView</a> library, which adds some nice (but non-standard) methods to the <code>DataView</code> API.</p>
<p><strong>We are going to tackle the ID3v2 spec,</strong> so our JavaScript MP3 reader won’t be an apples-to-apples comparison with the Elixir example, but meanwhile we will explore a few more Web APIs!</p>
<p>Let’s set up the Node project:</p>
<pre><code class="language-bash"># Create project directory
$ mkdir mp3-reader &amp;&amp; cd mp3-reader

# Init package.json with defaults
$ npm init -y

# Install TextDecoder polyfill
$ npm install --save text-encoding

# Create main file and make it executable
$ touch index.js &amp;&amp; chmod u+x index.js
</code></pre>
<h2 id="readinginafile">Reading in a File</h2>
<p>First off, we need to read in a file. In <code>index.js</code>, we’ll use the core <code>fs</code> library to asynchronously read in the specified MP3 file. This is the <em>only</em> Node specific code—after you read in a file, everything else will work in the browser!</p>
<pre><code class="language-javascript">#!/usr/bin/env node
let fs = require('fs');

const file = process.argv[2];

fs.readFile(file, (err, data) =&gt; {

});
</code></pre>
<p>Since this is an executable file, the first line—called a “<a href="https://en.wikipedia.org/wiki/Shebang_%28Unix%29">shebang</a>”—instructs the shell to execute this script with the Node interpreter. Now we can run it in the terminal:</p>
<pre><code class="language-bash">./index.js fixtures/sibelius.mp3
</code></pre>
<p>When we execute <code>index.js</code>, <code>process.argv</code> will look like this:</p>
<pre><code class="language-javascript">[ '/Users/jonathan/.nvm/versions/node/v6.10.0/bin/node',
  '/Users/jonathan/projects/mp3-reader/index.js',
  'fixtures/sibelius.mp3' ]
</code></pre>
<p><code>process.argv</code> is an array of at least two items: the full path to the Node executable and the full path to <code>index.js</code>. Any extra arguments passed to our script will begin at index 2, so <code>process.argv[2]</code> will be the path to the MP3 file we should read.</p>
<p>The <code>fs.readFile()</code> method accepts a callback, which will be invoked with an error argument and a Node <a href="https://nodejs.org/api/buffer.html"><code>Buffer</code></a> object. <code>Buffer</code>s have been around for a while, but they are specific to Node—you won’t find <code>Buffer</code>s in the browser. However, <a href="https://nodejs.org/api/buffer.html#buffer_buffers_and_typedarray">Node has switched the underlying implementation</a> of <code>Buffer</code> to a standardized JavaScript datatype: <code>ArrayBuffer</code>. In fact, <code>Buffer</code> objects have a <code>.buffer</code> property which returns the underlying <code>ArrayBuffer</code>!</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code>s</a> are a performant way to store large chunks of data, especially binary data. You’ll find them in graphics APIs like <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API">WebGL</a> and in <a href="https://developer.mozilla.org/en-US/docs/Web/API/Transferable">multithreading</a>. Since they’re part of the core language library, <strong>you can use <code>ArrayBuffer</code>s in both Node.js <em>and</em> the browser!</strong></p>
<p>To grab the Node <code>Buffer</code>’s underlying <code>ArrayBuffer</code>, we can destructure the <code>data</code> argument, which contains a Node <code>Buffer</code>, to extract just its <code>.buffer</code> property:</p>
<pre><code class="language-javascript">...

fs.readFile(file, (err, data) =&gt; {
  if (err) { throw err; }

  let { buffer } = data;
});
</code></pre>
<p>This fancy destructuring syntax is equivalent to <code>let buffer = data.buffer</code>. Now we’re ready to do the actual parsing!</p>
<h2 id="parsingtheid3header">Parsing the ID3 Header</h2>
<p>ID3v2 metadata comes at the beginning of the MP3 file and starts off with a 10 byte header. The first 3 bytes should always be the string <code>ID3</code>, followed by 7 more bytes.</p>
<p></p>
<p>The first two bytes after <code>ID3</code> (bytes 4 and 5) are version numbers. However, we can’t directly access the data in an <code>ArrayBuffer</code>: we need to create a <code>DataView</code> object to “view” that data.</p>
<pre><code class="language-javascript">...

const HEADER_SIZE = 10;

fs.readFile(file, (err, data) =&gt; {
  ...

  let header = new DataView(buffer, 0, HEADER_SIZE);

  let major = header.getUint8(3);
  let minor = header.getUint8(4);
  let version = `ID3v2.${major}.${minor}`;
  console.log(version);
});
</code></pre>
<p><code>DataView</code>s do not contain the data themselves, but they provide a “window” to “peer” into an <code>ArrayBuffer</code>. This means you can create multiple <code>DataView</code>s for the same <code>ArrayBuffer</code>—a clever design pattern for referencing the same chunk of memory with a different lens.</p>
<p>When creating a <code>DataView</code>, we specify the byte offset of where we want the “window” to start and how many bytes afterwards should be visible. While these two arguments are optional, they prevent us from “peering too far” and will throw useful exceptions if we attempt to access anything beyond these specified boundaries.</p>
<p>To grab the ID3 version numbers, we used the <code>.getUint8()</code> method. This method reads a single byte at the specified position relative to the <code>DataView</code>’s offset. In this case, it reads bytes 3 and 4 relative to an offset of 0.</p>
<p>The ID3 metadata section can be fairly long, so next we need to know the ID3 metadata’s total size (in bytes) so we don’t read too far and begin parsing the actual MP3 audio data.</p>
<pre><code class="language-javascript">...

let synchToInt = synch =&gt; {
  const mask = 0b01111111;
  let b1 = synch &amp; mask;
  let b2 = (synch &gt;&gt; 8) &amp; mask;
  let b3 = (synch &gt;&gt; 16) &amp; mask;
  let b4 = (synch &gt;&gt; 24) &amp; mask;

  return b1 | (b2 &lt;&lt; 7) | (b3 &lt;&lt; 14) | (b4 &lt;&lt; 21);
};

fs.readFile(file, (err, data) =&gt; {
  ...

  let size = synchToInt(header.getUint32(6));
});
</code></pre>
<p>Quite a bit going on there! Let's break this down. We read a 32-bit integer (4 bytes) starting at offset 6 (bytes 7–10) of the header that tells us how long the rest of the metadata is. Unfortunately, it’s not just a simple 32-bit integer: it’s a so-called “synchsafe” integer.</p>
<p></p>
<p>A <a href="https://en.wikipedia.org/wiki/Synchsafe">synchsafe integer</a> is essentially a 28-bit integer with a <code>0</code> added after every 7 bits. It’s pretty weird, but luckily we have low level boolean logic at our fingertips: we’ll just break up the synchsafe integer into 4 bytes, then combine them back with the 8th bit of each byte removed.</p>
<p></p>
<p>Why doesn’t the ID3 spec just use a regular 32-bit integer? MP3 was designed to be broadcast friendly, so audio players need to be able to play an MP3 from any given spot by watching for the next valid chunk of audio. Each chunk of audio begins with 11 bits set to <code>1</code> called the “frame sync.” By using synchsafe integers in the metadata section, this prevents interference with the “frame sync” mechanism. It’s still quite possible to have a sequence of 11 true bits elsewhere, but it’s fairly unlikely and players can easily perform correctness checks.</p>
<p>We’re done reading the 10-byte ID3 header, now it’s time to start looping through the “frames” that come next:</p>
<pre><code class="language-javascript">...

fs.readFile(file, (err, data) =&gt; {
  ...

  let offset = HEADER_SIZE;
  let id3Size = HEADER_SIZE + size;

  while (offset &lt; id3Size) {

  }
});
</code></pre>
<p>ID3 metadata is stored in consecutive chunks called “frames.” Each frame represents a separate key-value pair, like the song’s title or composer. We can read them in by parsing one frame at a time, then skipping by the size of that frame to read the next one until we reach the end of the ID3 metadata. In a moment, we’ll write a function called <code>decodeFrame()</code> to handle this, but if it was implemented we could parse all the frames like such:</p>
<pre><code class="language-javascript">...

fs.readFile(file, (err, data) =&gt; {
  ...

  while (offset &lt; id3Size) {
    let frame = decodeFrame(buffer, offset);
    if (!frame) { break; }
    console.log(`${frame.id}: ${frame.value.length &gt; 200 ? '...' : frame.value}`);
    offset += frame.size;
  }
});
</code></pre>
<h2 id="parsinganid3frame">Parsing an ID3 Frame</h2>
<p>Time to implement <code>decodeFrame()</code>! This function should return an object for one frame (key-value pair) structured like this:</p>
<pre><code class="language-javascript">{ id: 'TIT2',
  value: 'Snöfrid (Snowy Peace)',
  lang: 'eng',
  size: 257 }
</code></pre>
<p>Each frame begins with a 10-byte header, then is followed by the frame’s actual content (the value).</p>
<pre><code class="language-javascript">...

let decodeFrame = (buffer, offset) =&gt; {
  let header = new DataView(buffer, offset, HEADER_SIZE + 1);
  if (header.getUint8(0) === 0) { return; }
};
</code></pre>
<p>After creating an 11-byte <code>DataView</code> (why 11 instead of 10? Hang tight) to inspect the frame’s header, we checked to make sure the first byte isn’t a zero, which would indicate there are no more frames to decode. Many MP3 encoders pad the ID3 metadata section with extra <code>0</code>s (usually 2048 bytes of “null-padding”) to give audio players like iTunes room to insert more metadata without disturbing the rest of the file.</p>
<p>If the frame doesn’t start with zero, it’s safe to read in the first part of the header: the 4-byte frame ID. Frames are basically a single key-value pair, and the frame ID is the “key” of that pair:</p>
<p></p>
<pre><code class="language-javascript">...

let { TextDecoder } = require('text-encoding');
let decode = (format, string) =&gt; new TextDecoder(format).decode(string);

let decodeFrame = (buffer, offset) =&gt; {
  ...

  let id = decode('ascii', new Uint8Array(buffer, offset, 4));
};
</code></pre>
<p>The 4-character frame ID is encoded as an ASCII string, like <code>TIT2</code> (Title) or <code>TCOM</code> (Composer). To read in multiple bytes at a time, we need a different kind of view called a <code>TypedArray</code>. It’s not a constructor you’ll invoke directly, rather it refers to a class of fixed size homogeneous arrays. So to read in a list of unsigned 8-bit integers, we create a new <code>Uint8Array</code> typed array. If we wanted to read in signed (negative) numbers, we would use the <code>Int8Array</code> constructor instead, but that makes no sense for reading in ASCII bytes.</p>
<p>It’s not enough to fetch an array of 4 bytes—they need to be interpreted, or “decoded,” into a string. Frame IDs map directly to ASCII characters, so we invoked the <code>TextDecoder</code> constructor and its <code>.decode()</code> method to convert the byte array to a string.</p>
<p>Earlier we created an 11-byte <code>DataView</code> starting at the frame’s beginning. After the 4-byte frame ID comes the frame’s size:</p>
<pre><code class="language-javascript">...

let decodeFrame = (buffer, offset) =&gt; {
  ...

  let size = header.getUint32(4);
  let contentSize = size - 1;
  let encoding = header.getUint8(HEADER_SIZE);

  let contentOffset = offset + HEADER_SIZE + 1;
};
</code></pre>
<p>Bytes at indices 4–7 represent the rest of the frame’s size as an unsigned 32-bit integer. We don’t care about the 2 flag bytes which follow, so we are done decoding the frame header. But since it is only 10 bytes long, why did we read in 11? The first byte after the frame header (the 11th byte, index 10) specifies how the frame’s content is encoded, so in a way it is part of the frame header. To compensate for this “extra header byte,” we increased the <code>contentOffset</code> and decreased <code>contentSize</code> by <code>1</code>.</p>
<p>This “encoding byte” can be set to <code>0</code>, <code>1</code>, <code>2</code> or <code>3</code>, and maps to a text encoding like <code>ascii</code> or <code>utf-8</code>. This will help immensely, otherwise we might get gobbledygook if we mistakenly interpreted <code>utf-8</code> text as <code>ascii</code>.</p>
<h2 id="decodingstrings">Decoding Strings</h2>
<p>Finally, the frame’s real content begins at offset 11 of the frame. In addition to the encoding byte, some frames are also prefixed with a language descriptor:</p>
<pre><code class="language-javascript">...

const LANG_FRAMES = [
  'USLT',
  'SYLT',
  'COMM',
  'USER'
];

let decodeFrame = (buffer, offset) =&gt; {
  ...

  let lang;
  if (LANG_FRAMES.includes(id)) {
    lang = decode('ascii', new Uint8Array(buffer, contentOffset, 3));
    contentOffset += 3;
    contentSize -= 3;
  }
};
</code></pre>
<p>The language identifier is a 3 letter ASCII string, like <code>eng</code> or <code>deu</code>. Only certain frame types, like <code>COMM</code> (Comments), have a language identifier. Now onward to the real content!</p>
<pre><code class="language-javascript">...

const ID3_ENCODINGS = [
  'ascii',
  'utf-16',
  'utf-16be',
  'utf-8'
];

let decodeFrame = (buffer, offset) =&gt; {
  ...

  let value = decode(ID3_ENCODINGS[encoding],
    new Uint8Array(buffer, contentOffset, contentSize));
};
</code></pre>
<p>We finally grab the rest of the frame and decode the bytestream based on the encoding byte. For example, when <code>encoding</code> is set to <code>0</code> we interpret the frame’s content as <code>ascii</code>.</p>
<p>Now we just need to send everything back in a nice package:</p>
<pre><code class="language-javascript">...

let decodeFrame = (buffer, offset) =&gt; {
  ...

  return {
    id, value, lang,
    size: size + HEADER_SIZE
  };
};
</code></pre>
<p>There’s one catch: the frame size didn’t include the 10 byte frame header, so we added <code>HEADER_SIZE</code> to the returned size so the <code>while</code> loop can increment its offset by <code>frame.size</code> to hop to the next frame.</p>
<p>Time to run our script! Find an MP3 file and pass it to <code>index.js</code>. If it doesn’t print out <code>ID3v2.3.0</code>, try another MP3.</p>
<pre><code class="language-bash">$ ./index.js fixtures/sibelius.mp3

ID3v2.3.0
PRIV: ...
TIT2: Snöfrid (Snowy Peace), Improvisation for Reciter, Chorus and Orchestra, Op. 29
TPE1: Lahti Symphony Orchestra, Jubilate Choir, Stina Ekblad and Osmo Vänskä
TALB: Sibelius: The Complete Symphonies - Karelia - Lemminkäinen - Violin Concerto
TCON: Classical
TCOM: Jean Sibelius
TPE3: Osmo Vänskä
TRCK: 38/43
TYER: 2011
COMM: Amazon.com Song ID: 222429669
TPE2: Lahti Symphony Orchestra and Osmo Vänskä
TCOP: 2011 Bis
TPOS: 1/1
APIC: ...
</code></pre>
<p>Hey look! We got the special Unicode characters to interpret correctly. Good ‘ol Osmo Vänskä (the conductor) gets his proper accents for free. If the parser was even one byte off, you’d get gobbledygook. Or if you mixed your <code>ID3_ENCODINGS</code> a bit, you might find yourself staring at <a href="https://en.wikipedia.org/wiki/Byte_order_mark">byte order marks</a> (BOM) and other gunk not-meant-to-be-seen-by-mortals:</p>
<pre><code>ID3v2.3.0
PRIV: ...
TIT2: ǿ﹓nöfrid (Snowy Peace), Improvisation for Reciter, Chorus and Orchestra, Op. 29�
TPE1: ǿ﹌ahti Symphony Orchestra, Jubilate Choir, Stina Ekblad and Osmo Vänskä�
TALB: ǿ﹓ibelius: The Complete Symphonies - Karelia - Lemminkäinen - Violin Concerto�
TCON: ǿ﹃lassical�
TCOM: ǿ﹊ean Sibelius�
TPE3: ǿ﹏smo Vänskä�
TRCK: ǿ︳8/43�
TYER: ǿ︲011�
COMM: ť湧䄀洀愀稀漀渀⸀挀漀洀 匀漀渀最 䤀䐀㨀 ㈀㈀㈀㐀㈀㤀㘀㘀㤀
TPE2: ǿ﹌ahti Symphony Orchestra and Osmo Vänskä�
TCOP: ǿ︲011 Bis�
TPOS: ǿ︱/1�
APIC: ...
</code></pre>
<p>Boom! You can <a href="https://github.com/nybblr/mp3-reader">download the finished code here</a>.</p>
<h2 id="encore">Encore!</h2>
<p>Thanks to the <code>ArrayBuffer</code>, <code>DataView</code>, <code>TypedArray</code> and <code>TextDecoder</code> APIs, you can easily decode binary file formats. Although dealing with file specs can be notoriously tricky, JavaScript’s console-friendly ways make it easy to practice <a href="https://en.wikipedia.org/wiki/Exploratory_programming">exploratory programming</a> to work out the kinks and off-by-one errors.</p>
<p>If you need a more extensive MP3 metadata parser for your binary libretti, you’ll probably want to use a library like <a href="https://github.com/aadsm/jsmediatags">JSMediaTags</a>.</p>
<p>And there you have it! A masterful binary performance of Snöfrid by the JavaScript Symphony Orchestra, conducted by Node.js.</p>
<blockquote>
<p><em>If you choose me, then you choose the tempest.</em><br />
<em>For the hardy poems of the hero’s life say:</em><br />
<em>Draw your sword against vile giants,</em><br />
<em>bleed valiantly for the weak,</em><br />
<em>deny yourself with pleasure, never complain,</em><br />
<em>fight the hopeless fight and die nameless.</em><br />
<em>That is the true heroic saga of life.</em></p>
<p>—Viktor Rydberg</p>
</blockquote>


            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://jonathanleemartin.com">tl;dr</a> &copy; 2019</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
