<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">

    <title>Asyncing Feeling about JavaScript Generators</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <meta name="description" content="Async generators and async iteration are likely to ship before too long. Let’s investigate how async generators work and examine the challenges of using them." />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://www.bignerdranch.com/blog/asyncing-feeling-about-javascript-generators/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="tl;dr" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Asyncing Feeling about JavaScript Generators" />
    <meta property="og:description" content="Async generator functions have arrived in JavaScript! Iterate over Stream-like data with a for-loop and even rewrite ReactiveX.js. Read on to see what comes .next()…" />
    <meta property="og:url" content="https://www.bignerdranch.com/blog/asyncing-feeling-about-javascript-generators/" />
    <meta property="article:published_time" content="2017-01-18T12:00:00.000Z" />
    <meta property="article:modified_time" content="2019-08-09T16:05:21.000Z" />
    <meta property="article:tag" content="JavaScript" />
    
    <meta property="article:publisher" content="https://www.facebook.com/yellowscale" />
    <meta property="article:author" content="https://www.facebook.com/yellowscale" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Asyncing Feeling about JavaScript Generators" />
    <meta name="twitter:description" content="Async generator functions have arrived in JavaScript! Iterate over Stream-like data with a for-loop and even rewrite ReactiveX.js. Read on to see what comes .next()…" />
    <meta name="twitter:url" content="https://www.bignerdranch.com/blog/asyncing-feeling-about-javascript-generators/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Lee Martin" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="JavaScript" />
    <meta name="twitter:site" content="@nybblr" />
    <meta name="twitter:creator" content="@nybblr" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "tl;dr",
        "logo": {
            "@type": "ImageObject",
            "url": "https://jonathanleemartin.com/content/images/2019/08/logo.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Jonathan Lee Martin",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/6dc50195bf39376a9154e48d6b5df778?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://jonathanleemartin.com/author/jonathan/",
        "sameAs": [
            "https://jonathanleemartin.com/",
            "https://www.facebook.com/yellowscale",
            "https://twitter.com/nybblr"
        ]
    },
    "headline": "Asyncing Feeling about JavaScript Generators",
    "url": "https://jonathanleemartin.com/blog/asyncing-feeling-about-javascript-generators/",
    "datePublished": "2017-01-18T12:00:00.000Z",
    "dateModified": "2019-08-09T16:05:21.000Z",
    "keywords": "JavaScript",
    "description": "Async generator functions have arrived in JavaScript! Iterate over Stream-like data with a for-loop and even rewrite ReactiveX.js. Read on to see what comes .next()…",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jonathanleemartin.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.27" />
    <link rel="alternate" type="application/rss+xml" title="tl;dr" href="" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="https://jonathanleemartin.com">tl;dr</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Asyncing Feeling about JavaScript Generators</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/jonathan/">Jonathan Lee Martin</a></p>
                    <time class="post-date" datetime="2017-01-18">2017-01-18</time>
                </section>
            </header>
            <section class="post-content">

                <p><small><em>This post first appeared on the <a href="https://www.bignerdranch.com/blog/asyncing-feeling-about-javascript-generators/">Big Nerd Ranch blog</a>.</em></small></p>
<p><em>Want the <strong>TL;DR</strong> version? <a href="https://gist.github.com/nybblr/3af62797052c42f7090b4f8614b5e157">Here’s a gist of all three examples</a>.</em></p>
<p><a href="https://github.com/tc39/proposal-async-iteration">Async generators and async iteration have arrived</a>! Err, they’ve reached <a href="https://tc39.github.io/process-document/">Stage 3</a>, which means they are likely to ship in a future version of JavaScript. Until then, you can enable Stage 3 proposals in <a href="https://babeljs.io/repl/#?presets=stage-3">Babel</a> to try them out in your own projects.</p>
<p>The web is essentially a decentralized app runtime, so subpar language additions have permanent consequences since future standards must remain backwards compatible. So for a feature to be accepted into the ECMAScript standard, it has to be incredibly compelling—it takes more than snazzy syntax or theoretical elegance for a feature to make the cut.</p>
<p>With that in mind, we should expect async generators and iteration to substantially influence how we architect our future code, yet address a contemporary problem. Let’s investigate how async generators work and examine the challenges of using them in “real” codebases.</p>
<h2 id="recaphowasyncgeneratorswork">Recap: How Async Generators Work</h2>
<p>In a nutshell, async generators are like regular generator functions, but they yield Promises. If you aren’t familiar with ES2015 generator functions, check out Chris Aquino’s <a href="https://jonathanleemartin.com/blog/generators-rick-astley-and-the-sequence-of-fibonacci/">blog</a>, then watch Jafar Husain’s excellent talk on <a href="https://www.youtube.com/watch?v=lil4YCCXRYc">Async Programming</a>.</p>
<p>To recap, regular generator functions are basically a cross between the <a href="https://en.wikipedia.org/wiki/Iterator_pattern">Iterator</a> and <a href="https://en.wikipedia.org/wiki/Observer_pattern">Observer</a> patterns. A generator is a pausable function that you can “step” through by calling <code>.next()</code>. You can pull a value out of a generator multiple times with <code>.next()</code>, or push a value into the same function multiple times with <code>.next(valueToPush)</code>. This dual interface allows you to imitate both an Iterator and Observer with the same syntax!</p>
<p>However, generators have a disadvantage: they must <em>immediately</em> (synchronously) return data when <code>.next()</code> is invoked. Put another way, the code that <em>consumes</em> the data by calling <code>.next()</code> is in control of data flow. This is fine when the generator can generate new data on demand, but generators are not a good fit for iterating over asynchronous (or <em>temporal</em>) data sources, where the source itself controls when the next chunk of data is available.</p>
<p>WebSocket messages are a good example of an <em>asynchronous</em> data source. If we had a list of all the messages we would ever receive, we could iterate over them synchronously. But of course, we can’t know when messages will be received, so we need a mechanism to iterate lazily over messages as they arrive. Async generators and async iteration let us do just that!</p>
<p><strong>TL;DR:</strong> generator functions are for data sources where the data consumer is in control, whereas async generators allow the data source itself to be in control.</p>
<h2 id="simpleexamplegenerateandconsumeanasyncgenerator">Simple Example: Generate and Consume an AsyncGenerator</h2>
<p>Let’s exercise our async chops with an example. We want to write an async generator function that repeatedly generates a new number after waiting a random number of milliseconds. Over a period of several seconds it might generate five or so numbers starting from 0. Let’s first write a helper function that generates a Promise to represent a timer:</p>
<pre><code class="language-javascript">// Create a Promise that resolves after ms time
var timer = function(ms) {
  return new Promise(resolve =&gt; {
    setTimeout(resolve, ms);
  });
};
</code></pre>
<p>Calling <code>timer(5000)</code> returns a Promise that will resolve in 5 seconds. Now we’re ready to write an async generator:</p>
<pre><code class="language-javascript">// Repeatedly generate a number starting
// from 0 after a random amount of time
var source = async function*() {
  var i = 0;
  while (true) {
    await timer(Math.random() * 1000);
    yield i++;
  }
};
</code></pre>
<p>So much complexity hiding behind such elegance! Our async generator function waits a random amount of time, then <code>yield</code>s the next number in the count-up. If we didn’t have async generators, we could try using a regular generator function to <code>yield</code> Promises like this:</p>
<pre><code class="language-javascript">var source = function*() {
  var i = 0;
  while (true) {
    yield timer(Math.random() * 1000)
      .then(() =&gt; i++);
  }
};
</code></pre>
<p>However, there are some edge cases and boilerplate we’d have to handle, so it’s nice to have a dedicated function type! Now we’re ready to write the consuming code; because we need the <code>await</code> operator, we’ll create an async <code>run()</code> function.</p>
<pre><code class="language-javascript">// Tie everything together
var run = async function() {
  var stream = source();
  for await (let n of stream) {
    console.log(n);
  }
};

run();
// =&gt; 0
// =&gt; 1
// =&gt; 2
// =&gt; 3
// ...
</code></pre>
<p>What magic, and in under 20 lines of code! First, we invoke the <code>source</code> async generator function, which returns a special <code>AsyncGenerator</code> object. Then we use the <code>for await...of</code> loop syntax—called “asynchronous iteration”—to loop over numbers one-by-one as <code>source</code> generates them.</p>
<p><strong>But we can level up:</strong> suppose we want to square the numbers generated by <code>source</code>. We could square directly inside the <code>for await...of</code> loop, but it’d be better to “transform” the stream of values outside the loop, similar to using <code>.map()</code> to transform an array of values. It’s quite straightforward:</p>
<pre><code class="language-javascript">// Return a new async iterator that applies a
// transform to the values from another async generator
var map = async function*(stream, transform) {
  for await (let n of stream) {
    yield transform(n);
  }
};
</code></pre>
<p>Then we just need to add a line to the <code>run()</code> function:</p>
<pre><code class="language-diff"> // Tie everything together
 var run = async function() {
   var stream = source();
+  // Square values generated by source() as they arrive
+  stream = map(stream, n =&gt; n * n);
   for await (let n of stream) {
     console.log(n);
   }
 };
</code></pre>
<p>Now when we <code>run()</code> everything:</p>
<pre><code class="language-javascript">// =&gt; 0
// =&gt; 1
// =&gt; 4
// =&gt; 9
// ...
</code></pre>
<p>Impressive! But perhaps generating counting numbers isn’t especially innovative.</p>
<h2 id="mediumexamplewriteanasynciteratorforwebsockets">Medium Example: Write an AsyncIterator for WebSockets</h2>
<p>The usual way to respond to incoming WebSocket messages is to attach an event listener:</p>
<pre><code class="language-javascript">var ws = new WebSocket('ws://localhost:3000/');
ws.addEventListener('message', event =&gt; {
  console.log(event.data);
});
</code></pre>
<p>But if we treated WebSocket messages as a stream, it seems natural to “iterate” over messages as they arrive. Unfortunately, WebSockets are not yet async iterable, but we can write our own polyfill in just a few lines. Here’s what our <code>run()</code> function will look like:</p>
<pre><code class="language-javascript">// Tie everything together
var run = async () =&gt; {
  var ws = new WebSocket('ws://localhost:3000/');
  for await (let message of ws) {
    console.log(message);
  }
};
</code></pre>
<p>Now for that polyfill. You may recall from <a href="https://jonathanleemartin.com/blog/generators-rick-astley-and-the-sequence-of-fibonacci/">Chris Aquino’s blog series</a> that, for an object to be iterable with the <code>for...of</code> loop, you must define the <code>Symbol.iterator</code> property on that object. Similarly, to make an object async iterable with the <code>for await...of</code> loop, its <code>Symbol.asyncIterator</code> property must be defined. Here’s an implementation:</p>
<pre><code class="language-javascript">// Add an async iterator to all WebSockets
WebSocket.prototype[Symbol.asyncIterator] = async function*() {
  while(this.readyState !== 3) {
    yield (await oncePromise(this, 'message')).data;
  }
};
</code></pre>
<p>This async iterator waits to receive a message, then <code>yield</code>s the <code>data</code> attribute of the WebSocket’s <code>MessageEvent</code>. The <code>oncePromise()</code> function is a bit of a hack: it returns a Promise that resolves when an event occurs, then immediately unsubscribes:</p>
<pre><code class="language-javascript">// Generate a Promise that listens only once for an event
var oncePromise = (emitter, event) =&gt; {
  return new Promise(resolve =&gt; {
    var handler = (...args) =&gt; {
      emitter.removeEventListener(event, handler);
      resolve(...args);
    };
    emitter.addEventListener(event, handler);
  });
};
</code></pre>
<p>It seems inefficient, but it really tidies up our async iterator. If you have a chatty WebSocket server running at <a href="http://localhost:3000">http://localhost:3000</a>, you can watch messages stream in by invoking <code>run()</code>:</p>
<pre><code class="language-javascript">run();
// =&gt; "hello"
// =&gt; "sandwich"
// =&gt; "otters"
// ...
</code></pre>
<h2 id="hardexamplerewriterxjs">Hard Example: Rewrite RxJS</h2>
<p>Now for the ultimate challenge. <a href="https://en.wikipedia.org/wiki/Functional_reactive_programming">Functional reactive programming</a> (FRP) is all the rage in UI programming, and in JavaScript, <a href="http://reactivex.io/rxjs/manual/overview.html">RxJS</a> is the most popular library for this programming style. RxJS models event sources as <code>Observable</code>s—they’re like an event stream or lazy array that can be modified with familiar array idioms like <code>map()</code> and <code>filter()</code>.</p>
<p>Since FRP complements JavaScript’s non-blocking philosophy, it’s possible an <a href="https://github.com/tc39/proposal-observable">RxJS-like API</a> will make it to a future version of JavaScript. Meantime, we can write our own RxJS clone with async generators in just 80 lines of code! Here’s the challenge:</p>
<ol>
<li>Listen for all click events</li>
<li>Filter down to only clicks on anchor tags</li>
<li>Only allow distinct clicks</li>
<li>Map from click events to a click counter and the click event</li>
<li>Throttle clicks to once every 500ms</li>
<li>Print the click counter and event</li>
</ol>
<p>This type of problem is right in RxJS’s wheelhouse, so we’ll try to replicate its approach. Here’s how we’ll exercise our implementation:</p>
<pre><code class="language-javascript">// Tie everything together
var run = async () =&gt; {
  var i = 0;
  var clicks = streamify('click', document.querySelector('body'));

  clicks = filter(clicks, e =&gt; e.target.matches('a'));
  clicks = distinct(clicks, e =&gt; e.target);
  clicks = map(clicks, e =&gt; [i++, e]);
  clicks = throttle(clicks, 500);

  subscribe(clicks, ([ id, click ]) =&gt; {
    console.log(id);
    console.log(click);
    click.preventDefault();
  });
};

run();
</code></pre>
<p>To make this work, we need to write six functions: <code>streamify()</code>, <code>filter()</code>, <code>distinct()</code>, <code>map()</code>, <code>throttle()</code> and <code>subscribe()</code>.</p>
<pre><code class="language-javascript">// Turn any event emitter into a stream
var streamify = async function*(event, element) {
  while (true) {
    yield await oncePromise(element, event);
  }
};
</code></pre>
<p><code>streamify()</code> is just like the WebSocket async iterator: <code>oncePromise()</code> uses <code>.addEventListener()</code> to listen once for an event, then resolves the Promise. By looping with <code>while (true)</code>, we can listen for events indefinitely.</p>
<pre><code class="language-javascript">// Only pass along events that meet a condition
var filter = async function*(stream, test) {
  for await (var event of stream) {
    if (test(event)) {
      yield event;
    }
  }
};
</code></pre>
<p><code>filter()</code> only <code>yield</code>s events that pass the test. <code>map()</code> is almost identical:</p>
<pre><code class="language-javascript">// Transform every event of the stream
var map = async function*(stream, transform) {
  for await (var event of stream) {
    yield transform(event);
  }
};
</code></pre>
<p>Instead of testing before yielding, <code>map()</code> simply transforms the event before yielding. <code>distinct()</code> shows one of the superpowers of async generators: they can persist state with local variables!</p>
<pre><code class="language-javascript">var identity = e =&gt; e;

// Only pass along events that differ from the last one
var distinct = async function*(stream, extract = identity) {
  var lastVal;
  var thisVal;
  for await (var event of stream) {
    thisVal = extract(event);
    if (thisVal !== lastVal) {
      lastVal = thisVal;
      yield event;
    }
  }
};
</code></pre>
<p>Last, the mighty <code>throttle()</code> function resembles <code>distinct()</code>: it tracks the timestamp of the last event and only <code>yield</code>s it if a certain amount of time has passed since the last <code>yield</code>ed event.</p>
<pre><code class="language-javascript">// Only pass along event if some time has passed since the last one
var throttle = async function*(stream, delay) {
  var lastTime;
  var thisTime;
  for await (var event of stream) {
    thisTime = (new Date()).getTime();
    if (!lastTime || thisTime - lastTime &gt; delay) {
      lastTime = thisTime;
      yield event;
    }
  }
};
</code></pre>
<p>Finally, we need to print out the click event and counter for every event that made it this far. <code>subscribe()</code> is trivial: it just loops over every event and runs the callback, no <code>yield</code>s necessary.</p>
<pre><code class="language-javascript">// Invoke a callback every time an event arrives
var subscribe = async (stream, callback) =&gt; {
  for await (var event of stream) {
    callback(event);
  }
};
</code></pre>
<p>And with that, we’ve written our own functional reactive pipeline!</p>
<p><a href="https://gist.github.com/nybblr/3af62797052c42f7090b4f8614b5e157">Check out the gist</a> if you want to try out any of these examples.</p>
<h2 id="challenges">Challenges</h2>
<p>Async generators are pretty awesome. Whereas generator functions allow us to pull data out of an iterator, async generators let us iterate over data that is “pushed” to us. They’re a great abstraction for asynchronous data structures. However, there are some caveats.</p>
<p>First, implementing support for the <code>for await...of</code> on objects is a bit gnarly unless you avoid <code>yield</code> and <code>await</code>. Notably, converting anything with <code>.addEventListener()</code> is tricky because you can’t use the <code>yield</code> operator within the callback:</p>
<pre><code class="language-javascript">var streamify = async function*(event, element) {
  element.addEventListener(event, e =&gt; {
    // This doesn't work because yield is being
    // called from inside another function.
    yield e;
  });
};
</code></pre>
<p>Similarly, you can’t use <code>yield</code> within <code>.forEach()</code> or other functional methods. This is an inherent limitation since there’s no guarantee <code>yield</code> won’t be used <em>after</em> the generator has already finished.</p>
<p>To sidestep this, we wrote the <code>oncePromise()</code> helper. Apart from potential performance issues, it’s important to note that Promise callbacks always execute after the current callstack has finished. In browsers that run Promise callbacks as <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">microtasks</a>, this shouldn’t cause issues, but some Promise polyfills won’t run the callbacks until the next run of the event loop. Consequently, invoking the <code>.preventDefault()</code> method may have no effect since the DOM event may have already bubbled to the browser.</p>
<p>JavaScript now has several asynchronous stream datatypes: <code>Stream</code>, <code>AsyncGenerator</code> and eventually <code>Observable</code>. While all three fall into the continuum of “pushed” data sources, there are subtle semantic differences in how they handle back pressure and control the underlying resource. If you’re interested in the finer facets of functional reactive semantics, check out the <a href="https://github.com/kriskowal/gtor">General Theory of Reactivity</a>.</p>
<h2 id="moretocome">More to Come</h2>
<p>In the arms race for language features, JavaScript is no slacker. Destructuring in ES2015, async functions in ES2016, and now async iteration enable JavaScript to elegantly tackle the complexities of UI and I/O programming without resorting to the usual unpredictability of multi-threading.</p>
<p>And there’s much more to come! So keep an eye on the blog and the <a href="https://github.com/tc39/proposals">TC39 proposals repo</a> for new goodies. Meantime, you can start using async generator functions in your own code by <a href="https://babeljs.io/repl/#?presets=stage-3">enabling Stage 3 proposals in Babel</a>.</p>


            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://jonathanleemartin.com">tl;dr</a> &copy; 2019</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
